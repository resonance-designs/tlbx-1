import { ScrollView } from "std-widgets.slint";

import { Theme } from "../theme/index.slint";

/*
Component: StepperButton
Description: Internal helper for stepper increment/decrement buttons.
Public members:
- text: string - String to use to generate the icon.
- clicked(): callback - Triggered on click
*/
export component StepperButton inherits Rectangle {
    in property <string> text;
    callback clicked();

    width: 24px;
    height: 24px;
    border-radius: Theme.active.radius_small;
    border-color: Theme.active.border_strong;
    border-width: 1px;
    background: touch.pressed ? Theme.active.accent_secondary : Theme.active.background_main;

    Text {
        text: root.text;
        color: Theme.active.text_primary;
        font-family: Theme.active.font_icons;
        font-size: 20px;
        horizontal-alignment: center;
        vertical-alignment: center;
    }

    touch := TouchArea {
        clicked => { root.clicked(); }
    }
}

/*
Component: StepperReadout
Description: Internal helper for the interactive readout supporting drag, scroll and edit.
Public members:
- value: float - Current value
- min-value: float - Minimum bounds
- max-value: float - Maximum bounds
- font-family: string - Font family for the readout
- pad-digits: int - Number of digits to pad to (default: 3, clamped to 3)
- editing: bool - Whether currently in text input mode
- drag-start-y: length - Internal state for drag tracking
- drag-start-value: float - Internal state for drag tracking
- value-changed(float): callback - Triggered when value is modified
*/
export component StepperReadout inherits Rectangle {
    in-out property <float> value;
    in property <float> min-value;
    in property <float> max-value;
    in property <string> font-family: Theme.active.font_readout;
    in property <int> pad-digits: 3;
    in-out property <bool> editing;
    in-out property <length> drag-start-y;
    in-out property <float> drag-start-value;
    callback value-changed(float);

    private property <int> rounded-value: Math.round(root.value);
    private property <int> clamped-pad: Math.max(0, Math.min(3, root.pad-digits));
    private property <string> display-value:
        (root.rounded-value < 0 ? "-" : "") +
        (root.clamped-pad >= 3 && Math.abs(root.rounded-value) < 100 ? "0" : "") +
        (root.clamped-pad >= 2 && Math.abs(root.rounded-value) < 10 ? "0" : "") +
        Math.abs(root.rounded-value);

    width: 80px;
    height: 40px;
    clip: true;
    border-radius: Theme.active.radius_medium;
    border-color: Theme.active.border_strong;
    border-width: 1px;
    background: root.editing ? Theme.active.background_raised : Theme.active.background_main;

    if (!root.editing) : Text {
        text: root.display-value;
        color: #34D399;
        font-family: root.font-family;
        font-size: 26px;
        horizontal-alignment: center;
        vertical-alignment: center;
    }

    if (root.editing) : TextInput {
        text: root.display-value;
        color: Theme.active.text_primary;
        font-family: root.font-family;
        font-size: Theme.active.font_medium;
        horizontal-alignment: center;
        vertical-alignment: center;
        accepted => {
            root.value = self.text.to-float();
            root.value = Math.max(root.min-value, Math.min(root.max-value, root.value));
            root.editing = false;
            root.value-changed(root.value);
        }
    }

    TouchArea {
        visible: !root.editing;
        pointer-event(event) => {
            if (event.button == PointerEventButton.left && event.kind == PointerEventKind.down) {
                root.drag-start-y = self.mouse-y;
                root.drag-start-value = root.value;
            }
        }

        double-clicked => {
            root.editing = true;
        }

        moved => {
            if (self.pressed) {
                root.value = root.drag-start-value + (root.drag-start-y - self.mouse-y) / 1px;
                root.value = Math.max(root.min-value, Math.min(root.max-value, root.value));
                root.value-changed(root.value);
            }
        }

        scroll-event(event) => {
            root.value = root.value + (event.delta-y / 1px) * 0.1;
            root.value = Math.max(root.min-value, Math.min(root.max-value, root.value));
            root.value-changed(root.value);
            return accept;
        }
    }
}

/*
Component: RDSComboBox
Description: A custom dropdown with a styled trigger and popup list.

Public members:
- model: [string] - Items to show in the dropdown
- current-index: int - Currently selected index
- enabled: bool - Whether the control is interactive
- background: color - Background color for the trigger
- border-color: color - Border color for the trigger
- border-width: length - Border width for the trigger
- border-radius: length - Border radius for the trigger
- text-color: color - Text color for the trigger
- font-size: length - Text size for the trigger
- font-family: string - Font family for the trigger
- padding-horizontal: length - Left/right padding inside the trigger
- padding-vertical: length - Top/bottom padding inside the trigger
- item-height: length - Height of each row in the popup
- max-visible-items: int - Max visible rows before scrolling
- popup-background: color - Background color for the popup list
- selected(int): callback - Triggered when selection changes
*/
export component RDSComboBox {
    in property <[string]> model;
    in-out property <int> current-index: 0;
    in property <bool> enabled: true;

    in property <color> background: Theme.active.background_main;
    in property <color> border-color: Theme.active.border_strong;
    in property <length> border-width: 1px;
    in property <length> border-radius: Theme.active.radius_small;
    in property <color> text-color: Theme.active.text_primary;
    in property <length> font-size: Theme.active.font_small;
    in property <string> font-family: Theme.active.font_body;
    in property <length> padding-horizontal: 8px;
    in property <length> padding-vertical: 4px;
    in property <length> item-height: 28px;
    in property <int> max-visible-items: 6;
    in property <color> popup-background: Theme.active.background_raised;

    callback selected(index: int);

    width: 160px;
    height: 30px;

    private property <string> current-text:
        (root.model.length > 0 && root.current-index >= 0 && root.current-index < root.model.length)
        ? root.model[root.current-index]
        : "";
    private property <int> visible-items: Math.min(root.max-visible-items, root.model.length);

    Rectangle {
        width: parent.width;
        height: parent.height;
        background: root.background;
        border-color: root.border-color;
        border-width: root.border-width;
        border-radius: root.border-radius;
        clip: true;

        Text {
            x: root.padding-horizontal;
            y: root.padding-vertical;
            width: Math.max(0px, parent.width - (root.padding-horizontal * 2) - 18px);
            height: Math.max(0px, parent.height - (root.padding-vertical * 2));
            text: root.current-text;
            color: root.text-color;
            font-size: root.font-size;
            font-family: root.font-family;
            vertical-alignment: center;
            horizontal-alignment: left;
        }

        Text {
            width: 18px;
            height: parent.height;
            x: parent.width - 22px;
            text: "\u{e5cf}";
            font-family: Theme.active.font_icons;
            font-size: 18px;
            color: root.text-color;
            vertical-alignment: center;
            horizontal-alignment: center;
            opacity: root.enabled ? 1.0 : 0.5;
        }

        TouchArea {
            enabled: root.enabled;
            clicked => { popup.show(); }
        }
    }

    popup := PopupWindow {
        x: 0px;
        y: root.height;
        width: root.width;
        height: root.visible-items * root.item-height;
        close-policy: PopupClosePolicy.close-on-click;

        Rectangle {
            width: parent.width;
            height: parent.height;
            background: root.popup-background;
            border-color: root.border-color;
            border-width: root.border-width;
            border-radius: root.border-radius;
            clip: true;

            ScrollView {
                width: parent.width;
                height: parent.height;

                VerticalLayout {
                    spacing: 0px;
                    for item[index] in root.model : Rectangle {
                        width: root.width;
                        height: root.item-height;
                        background: ta.has-hover ? Theme.active.background_hover : #00000000;
                        Text {
                            x: root.padding-horizontal;
                            width: Math.max(0px, root.width - (root.padding-horizontal * 2));
                            height: parent.height;
                            text: item;
                            color: root.text-color;
                            font-size: root.font-size;
                            font-family: root.font-family;
                            vertical-alignment: center;
                            horizontal-alignment: left;
                        }
                        ta := TouchArea {
                            clicked => {
                                root.current-index = index;
                                root.selected(index);
                                popup.close();
                            }
                        }
                    }
                }
            }
        }
    }
}

/*
Component: RDSNumStepper
Description: A numeric stepper with forward/backwards buttons and an interactive readout.
Supports button placement (top/bottom or left/right), mouse scroll, vertical drag,
and double-click to type manual values.

Public members:
- value: float - Current numeric value
- min-value: float - Minimum allowed value
- max-value: float - Maximum allowed value
- step: float - Step size for increment/decrement buttons
- font-family: string - Font family for the readout (defaults to theme readout font)
- pad-digits: int - Number of digits to pad to (default: 3, clamped to 3)
- button-tog: bool - Whether to show the increment/decrement buttons (default: false)
- button-pos: string - "top-bottom" (default fallback) or "left-right" for button arrangement
- value-changed(float): callback - Triggered when the value changes via any interaction
*/

export component RDSNumStepper {
    in-out property <float> value: 120;
    in property <float> min-value: 20;
    in property <float> max-value: 300;
    in property <float> step: 1;
    in property <string> font-family: Theme.active.font_readout;
    in property <int> pad-digits: 3;
    in property <bool> button-tog: true;
    in-out property <string> button-pos: "top-bottom"; // "top-bottom" or "left-right"
    callback value-changed(float);

    private property <bool> editing: false;
    private property <length> drag-start-y: 0px;
    private property <float> drag-start-value: 0;

    width: button-pos == "left-right" ? (button-tog ? 160px : 100px) : 80px;
    height: button-pos == "left-right" ? 40px : (button-tog ? 110px : 60px);

    Rectangle {
        width: parent.width;
        height: parent.height;

        if (button-pos == "left-right") : HorizontalLayout {
            spacing: 6px;
            padding-left: 8px;
            padding-right: 8px;
            alignment: center;

            if (root.button-tog) : StepperButton {
                y: parent.height / 4.5;
                text: "\u{e5cb}"; // keyboard_arrow_left
                clicked => {
                    root.value = Math.max(root.min-value, root.value - root.step);
                    root.value-changed(root.value);
                }
            }

            StepperReadout {
                value <=> root.value;
                min-value: root.min-value;
                max-value: root.max-value;
                font-family: root.font-family;
                pad-digits: root.pad-digits;
                editing <=> root.editing;
                drag-start-y <=> root.drag-start-y;
                drag-start-value <=> root.drag-start-value;
                value-changed(v) => { root.value-changed(v); }
            }

            if (root.button-tog) : StepperButton {
                y: parent.height / 4.5;
                text: "\u{e5cc}"; // keyboard_arrow_right
                clicked => {
                    root.value = Math.min(root.max-value, root.value + root.step);
                    root.value-changed(root.value);
                }
            }
        }

        if (button-pos != "left-right") : VerticalLayout {
            spacing: 4px;
            padding-top: 4px;
            padding-bottom: 4px;
            alignment: center;

            if (root.button-tog) : StepperButton {
                x: parent.width / 3;
                text: "\u{e316}"; // keyboard_arrow_up
                clicked => {
                    root.value = Math.min(root.max-value, root.value + root.step);
                    root.value-changed(root.value);
                }
            }

            StepperReadout {
                value <=> root.value;
                min-value: root.min-value;
                max-value: root.max-value;
                font-family: root.font-family;
                pad-digits: root.pad-digits;
                editing <=> root.editing;
                drag-start-y <=> root.drag-start-y;
                drag-start-value <=> root.drag-start-value;
                value-changed(v) => { root.value-changed(v); }
            }

            if (root.button-tog) : StepperButton {
                x: parent.width / 3;
                text: "\u{e313}"; // keyboard_arrow_down
                clicked => {
                    root.value = Math.max(root.min-value, root.value - root.step);
                    root.value-changed(root.value);
                }
            }
        }
    }
}

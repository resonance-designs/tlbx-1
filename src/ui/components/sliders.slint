import { Theme } from "../theme/index.slint";

/*
Component: RDSSlider
Description: A versatile slider (fader) supporting vertical and horizontal orientations.
Public members:
- value: float - Current value
- min-value: float - Minimum bounds
- max-value: float - Maximum bounds
- size: string - "small", "medium", or "large"
- orientation: string - "vertical" or "horizontal"
- height-override: length - Custom height (or width if horizontal)
- value-changed(float): callback - Triggered when value changes
*/
export component RDSSlider inherits Rectangle {
    // Public properties
    in-out property <float> value: 0; // Current value
    in-out property <float> min-value: 0;
    in-out property <float> max-value: 127;
    in-out property <string> size: "large"; // "small", "medium", or "large"
    in-out property <string> orientation: "vertical"; // "vertical" or "horizontal"

    callback value-changed(float); // Callback when value changes

    // Private properties for drag tracking
    private property <length> drag-start-pos: 0px;
    private property <float> drag-start-value: 0;
    private property <float> drag-sensitivity: 1.0; // Adjust drag sensitivity
    private property <float> scroll-sensitivity: 1.0; // Adjust scroll sensitivity

    // Size scale factors
    private property <float> scale: root.size == "small" ? 0.5 : (root.size == "medium" ? 0.75 : 1.0);
    private property <bool> is-horizontal: root.orientation == "horizontal";

    // Scaled dimensions
    private property <length> base-width: 70px;
    private property <length> base-height: 420px;
    in-out property <length> height-override: 0px;
    private property <length> effective-height: root.height-override > 0px ? root.height-override : root.base-height * root.scale;
    private property <length> scaled-travel: Math.max(10px, root.effective-height - 120px * root.scale);

    width: root.is-horizontal ? root.effective-height : root.base-width * root.scale;
    height: root.is-horizontal ? root.base-width * root.scale : root.effective-height;
    clip: true;

    // Calculate button position based on value and orientation
    private property <length> button-pos: (17.5px * root.scale) + (root.effective-height - 102.5px * root.scale) * (1 - (root.value - root.min-value) / Math.max(0.01, root.max-value - root.min-value));

    markings-left := Rectangle {
        x: root.is-horizontal ? 50px * root.scale : 1px * root.scale;
        y: root.is-horizontal ? 1px * root.scale : 50px * root.scale;
        width: root.is-horizontal ? root.effective-height - 100px * root.scale : 25px * root.scale;
        height: root.is-horizontal ? 25px * root.scale : root.effective-height - 100px * root.scale;

        for idx[i] in 31 : Rectangle {
            x: root.is-horizontal
                ? (idx * 10px * root.scale)
                : (Math.mod(idx, 5) == 0 ? 0px : 10px * root.scale);
            y: root.is-horizontal
                ? (Math.mod(idx, 5) == 0 ? 0px : 10px * root.scale)
                : (idx * 10px * root.scale);
            width: root.is-horizontal
                ? 2px * root.scale
                : (Math.mod(idx, 5) == 0 ? 25px : 15px) * root.scale;
            height: root.is-horizontal
                ? (Math.mod(idx, 5) == 0 ? 25px : 15px) * root.scale
                : 2px * root.scale;
            background: Theme.active.border_strong;
        }
    }

    markings-right := Rectangle {
        x: root.is-horizontal ? 50px * root.scale : 44px * root.scale;
        y: root.is-horizontal ? 44px * root.scale : 50px * root.scale;
        width: root.is-horizontal ? root.effective-height - 100px * root.scale : 25px * root.scale;
        height: root.is-horizontal ? 25px * root.scale : root.effective-height - 100px * root.scale;

        for idx[i] in 31 : Rectangle {
            x: root.is-horizontal ? (idx * 10px * root.scale) : 0px;
            y: root.is-horizontal ? 0px : (idx * 10px * root.scale);
            width: root.is-horizontal
                ? 2px * root.scale
                : (Math.mod(idx, 5) == 0 ? 25px : 15px) * root.scale;
            height: root.is-horizontal
                ? (Math.mod(idx, 5) == 0 ? 25px : 15px) * root.scale
                : 2px * root.scale;
            background: Theme.active.border_strong;
        }
    }

    slider-range := Rectangle {
        x: root.is-horizontal ? 50px * root.scale : 30px * root.scale;
        y: root.is-horizontal ? 30px * root.scale : 50px * root.scale;
        width: root.is-horizontal ? root.effective-height - 100px * root.scale : 10px * root.scale;
        height: root.is-horizontal ? 10px * root.scale : root.effective-height - 100px * root.scale;
        background: root.is-horizontal ? @linear-gradient(
            90deg,
            Theme.active.background_main 0%,
            Theme.active.background_raised 100%) : @linear-gradient(
            180deg,
            Theme.active.background_main 0%,
            Theme.active.background_raised 100%);
        border-width: 2px * root.scale;
        border-color: root.is-horizontal ? @linear-gradient(
            90deg,
            Theme.active.border_strong 0%,
            Theme.active.border_subtle 100%) : @linear-gradient(
            180deg,
            Theme.active.border_strong 0%,
            Theme.active.border_subtle 100%);
        border-radius: 5px * root.scale;
    }

    drag-button := Rectangle {
        x: root.is-horizontal ? root.button-pos : 15px * root.scale;
        y: root.is-horizontal ? 15px * root.scale : root.button-pos;
        width: root.is-horizontal ? 70px * root.scale : 40px * root.scale;
        height: root.is-horizontal ? 40px * root.scale : 70px * root.scale;
        background: @linear-gradient(180deg, Theme.active.background_raised 0%, Theme.active.background_main 100%);
        border-color: @linear-gradient(180deg, Theme.active.border_strong 0%, Theme.active.background_main 100%);
        border-width: 3px * root.scale;
        border-radius: 10px * root.scale;
        drop-shadow-blur: 2px * root.scale;
        drop-shadow-color: #000;
        drop-shadow-offset-x: 2px * root.scale;
        drop-shadow-offset-y: 2px * root.scale;
        clip: true;

        grooves := Rectangle {
            width: root.is-horizontal ? 45px * root.scale : 40px * root.scale;
            height: root.is-horizontal ? 40px * root.scale : 45px * root.scale;
            groove1 := Rectangle {
                x: root.is-horizontal ? 0px : 0px;
                y: root.is-horizontal ? 0px : 0px;
                width: root.is-horizontal ? 2px * root.scale : 48px * root.scale;
                height: root.is-horizontal ? 48px * root.scale : 2px * root.scale;
                opacity: 0.8;
                background: Theme.active.border_subtle;
                drop-shadow-blur: 2px * root.scale;
                drop-shadow-color: #000000;
                drop-shadow-offset-x: root.is-horizontal ? 1px * root.scale : 0px;
                drop-shadow-offset-y: root.is-horizontal ? 0px : 1px * root.scale;
            }
            groove2 := Rectangle {
                x: root.is-horizontal ? 4px * root.scale : 0px;
                y: root.is-horizontal ? 0px : 4px * root.scale;
                width: root.is-horizontal ? 2px * root.scale : 40px * root.scale;
                height: root.is-horizontal ? 40px * root.scale : 2px * root.scale;
                background: Theme.active.border_subtle;
                drop-shadow-blur: 2px * root.scale;
                drop-shadow-color: #000000;
                drop-shadow-offset-x: root.is-horizontal ? 1px * root.scale : 0px;
                drop-shadow-offset-y: root.is-horizontal ? 0px : 1px * root.scale;
            }
            groove3 := Rectangle {
                x: root.is-horizontal ? 8px * root.scale : 0px;
                y: root.is-horizontal ? 0px : 8px * root.scale;
                width: root.is-horizontal ? 2px * root.scale : 40px * root.scale;
                height: root.is-horizontal ? 40px * root.scale : 2px * root.scale;
                background: Theme.active.border_subtle;
                drop-shadow-blur: 2px * root.scale;
                drop-shadow-color: #000000;
                drop-shadow-offset-x: root.is-horizontal ? 1px * root.scale : 0px;
                drop-shadow-offset-y: root.is-horizontal ? 0px : 1px * root.scale;
            }
            groove4 := Rectangle {
                x: root.is-horizontal ? 34px * root.scale : 0px;
                y: root.is-horizontal ? 0px : 34px * root.scale;
                width: root.is-horizontal ? 2px * root.scale : 40px * root.scale;
                height: root.is-horizontal ? 40px * root.scale : 2px * root.scale;
                background: Theme.active.border_subtle;
                drop-shadow-blur: 2px * root.scale;
                drop-shadow-color: #000000;
                drop-shadow-offset-x: root.is-horizontal ? 1px * root.scale : 0px;
                drop-shadow-offset-y: root.is-horizontal ? 0px : 1px * root.scale;
            }
            groove5 := Rectangle {
                x: root.is-horizontal ? 38px * root.scale : 0px;
                y: root.is-horizontal ? 0px : 38px * root.scale;
                width: root.is-horizontal ? 2px * root.scale : 40px * root.scale;
                height: root.is-horizontal ? 40px * root.scale : 2px * root.scale;
                background: Theme.active.border_subtle;
                drop-shadow-blur: 2px * root.scale;
                drop-shadow-color: #000000;
                drop-shadow-offset-x: root.is-horizontal ? 1px * root.scale : 0px;
                drop-shadow-offset-y: root.is-horizontal ? 0px : 1px * root.scale;
            }
            groove6 := Rectangle {
                x: root.is-horizontal ? 42px * root.scale : 0px;
                y: root.is-horizontal ? 0px : 42px * root.scale;
                width: root.is-horizontal ? 2px * root.scale : 40px * root.scale;
                height: root.is-horizontal ? 40px * root.scale : 2px * root.scale;
                background: Theme.active.border_subtle;
                drop-shadow-blur: 2px * root.scale;
                drop-shadow-color: #000000;
                drop-shadow-offset-x: root.is-horizontal ? 1px * root.scale : 0px;
                drop-shadow-offset-y: root.is-horizontal ? 0px : 1px * root.scale;
            }
        }

        drag-pointer := Rectangle {
            x: root.is-horizontal ? 32.5px * root.scale : 0px;
            y: root.is-horizontal ? 0px : 32.5px * root.scale;
            width: root.is-horizontal ? 5px * root.scale : 40px * root.scale;
            height: root.is-horizontal ? 40px * root.scale : 5px * root.scale;
            background: Theme.active.text_secondary;
        }

        // Touch area for dragging
        touch := TouchArea {
            width: parent.width;
            height: parent.height;

            pointer-event(event) => {
                if (event.button == PointerEventButton.left) {
                    if (event.kind == PointerEventKind.down) {
                        root.drag-start-pos = root.is-horizontal ? self.mouse-x : self.mouse-y;
                        root.drag-start-value = root.value;
                    }
                }
            }

            moved => {
                if (self.pressed) {
                    // Calculate new value based on drag
                    if (root.is-horizontal) {
                        // Horizontal: right increases value
                        root.value = root.drag-start-value + ((self.mouse-x - root.drag-start-pos) / root.scaled-travel) * (root.max-value - root.min-value) * root.drag-sensitivity;
                    } else {
                        // Vertical: up increases value
                        root.value = root.drag-start-value - ((self.mouse-y - root.drag-start-pos) / root.scaled-travel) * (root.max-value - root.min-value) * root.drag-sensitivity;
                    }

                    // Clamp value to range
                    root.value = Math.max(root.min-value, Math.min(root.max-value, root.value));

                    // Emit callback
                    root.value-changed(root.value);
                }
            }

            scroll-event(event) => {
                // Handle scroll wheel (convert delta-y from length to float)
                root.value = root.value - (event.delta-y / 1px) * root.scroll-sensitivity;

                // Clamp value to range
                root.value = Math.max(root.min-value, Math.min(root.max-value, root.value));

                // Emit callback
                root.value-changed(root.value);

                return accept;
            }
        }
    }
}

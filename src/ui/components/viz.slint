import { Theme } from "../theme/index.slint";

/*
Component: RDSWaveformViz
Description: Visualizes a static waveform with playhead, loop, trigger, and grain markers.
Public members:
- waveform: [float] - Amplitude values (0.0 to 1.0)
- waveform_time_labels: [string] - Time markers for the X-axis
- playhead-index: int - Current position in the waveform array
- loop-start: float - Normalized loop start (0.0..1.0)
- loop-length: float - Normalized loop length (0.0..1.0)
- loop-enabled: bool - Whether to show loop region
- trigger-start: float - Normalized trigger start (0.0..1.0)
- grain-markers: [float] - Normalized grain marker positions (0.0..1.0)
*/
export component RDSWaveformViz inherits Rectangle {
    in property <[float]> waveform;
    in property <[string]> waveform_time_labels;
    in property <int> playhead-index: 0;
    in property <float> loop-start: 0.0;
    in property <float> loop-length: 1.0;
    in property <bool> loop-enabled: false;
    in property <float> trigger-start: 0.0;
    in property <[float]> grain-markers;
    private property <int> waveform_length: Math.max(1, root.waveform.length);
    private property <int> waveform_label_length: Math.max(1, root.waveform_time_labels.length);
    private property <float> loop_start_clamped: Math.max(0.0, Math.min(1.0, root.loop-start));
    private property <float> loop_length_clamped: Math.max(0.0, Math.min(1.0, root.loop-length));
    private property <float> trigger_start_clamped: Math.max(0.0, Math.min(1.0, root.trigger-start));
    private property <float> loop_end:
        Math.min(1.0, root.loop_start_clamped + root.loop_length_clamped);
    private property <float> playhead_pos:
        root.waveform_length > 1
            ? Math.max(0.0, Math.min(1.0, root.playhead-index / (root.waveform_length - 1)))
            : 0.0;

    background: Theme.active.background_main;
    border-radius: Theme.active.radius_large;
    border-color: Theme.active.border_subtle;
    border-width: 1px;

    HorizontalLayout {
        padding: 8px;
        spacing: 8px;

        VerticalLayout {
            width: 44px;
            height: parent.height - 16px;
            spacing: 0px;
            Text { text: "+6 dB"; color: Theme.active.text_secondary; font-size: 10px; }
            Rectangle { height: (parent.height - 36px) / 2; width: 1px; background: transparent; }
            Text { text: "0 dB"; color: Theme.active.text_secondary; font-size: 11px; }
            Rectangle { height: (parent.height - 36px) / 2; width: 1px; background: transparent; }
            Text { text: "-60 dB"; color: Theme.active.text_secondary; font-size: 10px; }
        }

        VerticalLayout {
            spacing: 6px;
            width: parent.width - 60px;
            Rectangle {
                width: parent.width;
                height: parent.height - 20px;
                background: transparent;
                clip: true;

                Rectangle {
                    width: parent.width;
                    height: parent.height;
                    Rectangle {
                        visible: root.loop-enabled;
                        x: root.loop_start_clamped * parent.width;
                        width: Math.max(2px, (root.loop_end - root.loop_start_clamped) * parent.width);
                        height: parent.height;
                        background: #38bdf833;
                    }
                    Rectangle {
                        width: 2px;
                        height: parent.height;
                        x: root.trigger_start_clamped * parent.width;
                        background: #f97316;
                    }
                    Rectangle {
                        width: 2px;
                        height: parent.height;
                        x: root.loop_start_clamped * parent.width;
                        background: #60a5fa;
                        visible: root.loop-enabled;
                    }
                    Rectangle {
                        width: 2px;
                        height: parent.height;
                        x: root.loop_end * parent.width;
                        background: #60a5fa;
                        visible: root.loop-enabled;
                    }
                    for marker[i] in root.grain-markers : Rectangle {
                        width: 2px;
                        height: parent.height;
                        x: Math.max(0.0, Math.min(1.0, marker)) * parent.width;
                        background: #a855f7;
                        visible: marker >= 0.0;
                    }
                    for amp[index] in root.waveform : Rectangle {
                        width: parent.width / root.waveform_length;
                        height: parent.height;
                        x: index * (parent.width / root.waveform_length);
                        background: transparent;
                        Rectangle {
                            width: parent.width;
                            height: Math.max(2px, Math.abs(amp) * (parent.height - 4px));
                            y: (parent.height - self.height) / 2;
                            background: index < root.playhead-index ? Theme.active.accent_primary : Theme.active.accent_secondary;
                            border-radius: Theme.active.radius_small;
                        }
                    }
                    Rectangle {
                        width: 2px;
                        height: parent.height;
                        x: root.playhead_pos * parent.width;
                        background: #22c55e;
                    }
                }
            }

            Rectangle {
                width: parent.width;
                height: 14px;
                background: transparent;
                for label[i] in root.waveform_time_labels : Text {
                    text: label;
                    color: Theme.active.text_secondary;
                    font-size: 10px;
                    x: i * (parent.width / root.waveform_label_length);
                    y: 0px;
                }
            }
        }
    }
}

/*
Component: RDSVUMeter
Description: A horizontal VU meter.
Public members:
- level: float - Signal level (0.0 to 1.0)
- fill-color: color - Color of the level indicator
- vu-border-width: length - Width of the meter border
*/
export component RDSVUMeter {
    in property <float> level;
    in property <color> fill-color: Theme.active.meter_normal;
    in property <length> vu-border-width: 2px;
    property <float> clamped-level: Math.max(0.0, Math.min(1.0, root.level));

    width: 140px;
    height: 10px;

    Rectangle {
        width: parent.width;
        height: parent.height;
        background: Theme.active.background_main;
        border-radius: Theme.active.radius_medium;
        border-color: Theme.active.border_subtle;
        border-width: root.vu-border-width;

        Rectangle {
            width: Math.max(4px, root.clamped-level * parent.width);
            height: parent.height;
            background: root.fill-color;
            border-radius: Theme.active.radius_medium;
        }
    }
}

/*
Component: RDSVertVUMeter
Description: A vertical VU meter.
Public members:
- level: float - Signal level (0.0 to 1.0)
- fill-color: color - Color of the level indicator
- vu-border-width: length - Width of the meter border
*/
export component RDSVertVUMeter {
    in property <float> level;
    in property <color> fill-color: Theme.active.meter_normal;
    in property <length> vu-border-width: 2px;
    property <float> clamped-level: Math.max(0.0, Math.min(1.0, root.level));

    width: 12px;
    height: 88px;

    Rectangle {
        width: parent.width;
        height: parent.height;
        background: Theme.active.background_main;
        border-radius: Theme.active.radius_medium;
        border-color: Theme.active.border_subtle;
        border-width: root.vu-border-width;

        Rectangle {
            width: parent.width;
            height: Math.max(2px, root.clamped-level * parent.height);
            y: parent.height - self.height;
            background: root.fill-color;
            border-radius: Theme.active.radius_medium;
        }
    }
}

/*
Component: RDSOscilloscopeViz
Description: Visualizes a real-time signal as an oscilloscope trace.
Public members:
- oscilloscope: [float] - Signal samples
*/
export component RDSOscilloscopeViz inherits Rectangle {
    in property <[float]> oscilloscope;
    background: transparent;

    Rectangle {
        width: parent.width;
        height: parent.height;
        for sample[i] in root.oscilloscope : Rectangle {
            width: 2px;
            height: Math.max(2px, Math.abs(sample) * (parent.height - 4px));
            x: i * (parent.width / root.oscilloscope.length);
            y: (parent.height - self.height) / 2;
            background: Theme.active.accent_highlight;
        }
    }
}

/*
Component: RDSSpectrumViz
Description: Visualizes frequency spectrum data as vertical bars.
Public members:
- spectrum: [float] - Magnitude values per frequency bin
*/
export component RDSSpectrumViz inherits Rectangle {
    in property <[float]> spectrum;
    background: transparent;

    Rectangle {
        width: parent.width;
        height: parent.height;
        for mag[i] in root.spectrum : Rectangle {
            width: parent.width / root.spectrum.length;
            height: Math.max(2px, mag * (parent.height - 4px));
            x: i * (parent.width / root.spectrum.length);
            y: parent.height - self.height;
            background: Theme.active.accent_primary;
        }
    }
}

/*
Component: RDSVectorscopeViz
Description: Visualizes phase relationship between two signals (L/R).
Public members:
- vectorscope_x: [float] - Left channel signal samples
- vectorscope_y: [float] - Right channel signal samples
*/
export component RDSVectorscopeViz inherits Rectangle {
    in property <[float]> vectorscope_x;
    in property <[float]> vectorscope_y;
    background: transparent;

    // vectorscope_x/vectorscope_y are paired arrays and should stay in sync.
    private property <int> vectorscope_len: Math.min(root.vectorscope_x.length, root.vectorscope_y.length);

    Rectangle {
        width: parent.width;
        height: parent.height;
        for idx[i] in vectorscope_len : Rectangle {
            width: 2px;
            height: 2px;
            x: ((root.vectorscope_x[i] * 0.5) + 0.5) * parent.width;
            y: ((root.vectorscope_y[i] * -0.5) + 0.5) * parent.height;
            background: Theme.active.meter_normal;
        }
    }
}

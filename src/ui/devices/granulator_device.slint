import { Theme } from "../theme/index.slint";
import { RDSKnob, RDSHeaderLabel, RDSCircleToggle } from "../components/index.slint";

export component GranulatorDevice {
    in-out property <bool> mosaic-enabled: true;
    in-out property <float> mosaic-pitch: 0.0;
    in-out property <float> mosaic-rate: 0.5;
    in-out property <float> mosaic-size: 0.5;
    in-out property <float> mosaic-contour: 0.5;
    in-out property <float> mosaic-warp: 0.0;
    in-out property <float> mosaic-spray: 0.0;
    in-out property <float> mosaic-pattern: 0.0;
    in-out property <float> mosaic-wet: 0.0;
    in-out property <float> mosaic-detune: 0.0;
    in-out property <float> mosaic-spatial: 0.0;
    in-out property <float> mosaic-rand-rate: 0.0;
    in-out property <float> mosaic-rand-size: 0.0;
    in-out property <float> mosaic-sos: 0.0;
    in-out property <bool> mosaic-loop-lock: false;

    callback toggle-mosaic-enabled();
    callback mosaic-pitch-changed(value: float);
    callback mosaic-rate-changed(value: float);
    callback mosaic-size-changed(value: float);
    callback mosaic-contour-changed(value: float);
    callback mosaic-warp-changed(value: float);
    callback mosaic-spray-changed(value: float);
    callback mosaic-pattern-changed(value: float);
    callback mosaic-wet-changed(value: float);
    callback mosaic-detune-changed(value: float);
    callback mosaic-spatial-changed(value: float);
    callback mosaic-rand-rate-changed(value: float);
    callback mosaic-rand-size-changed(value: float);
    callback mosaic-sos-changed(value: float);
    callback toggle-mosaic-loop-lock();

    private property <[string]> rate-division-labels: [
        "1.", "1", "1/2.", "1T", "1/2", "1/4.", "1/2T", "1/4",
        "1/8.", "1/4T", "1/8", "1/16.", "1/8T", "1/16",
        "1/32.", "1/16T", "1/32", "1/32T"
    ];
    private property <int> rate-division-index:
        root.mosaic-rate <= 0.5
            ? Math.round((root.mosaic-rate / 0.5) * (root.rate-division-labels.length - 1))
            : 0;
    private property <string> rate-division-label:
        root.rate-division-labels[
            Math.max(0, Math.min(root.rate-division-labels.length - 1, root.rate-division-index))
        ];
    private property <string> rate-readout:
        root.mosaic-rate <= 0.5
            ? root.rate-division-label
            : ("Free " + Math.round(((root.mosaic-rate - 0.5) / 0.5) * 100) + "%");

    // Device Container
    VerticalLayout {
        spacing: 8px;

        // Device Name
        RDSHeaderLabel {
            text: "Granulator";
            horizontal-alignment: left;
            padding-horizontal: 12px;
            padding-vertical: 6px;
            right-padding: 12px;
            HorizontalLayout {
                spacing: 6px;
                alignment: center;
                RDSCircleToggle {
                    active: root.mosaic-enabled;
                    label: "Bypass";
                    label-active: "On";
                    label-pos: "left";
                    label-color: #b9b9bf;
                    label-active-color: Theme.active.text_primary;
                    label-font-size: 11px;
                    label-font-weight: 500;
                    clicked => root.toggle-mosaic-enabled();
                }
                RDSCircleToggle {
                    active: root.mosaic-loop-lock;
                    label: "Loop";
                    label-active: "In";
                    label-pos: "left";
                    label-color: #b9b9bf;
                    label-active-color: Theme.active.text_primary;
                    label-font-size: 11px;
                    label-font-weight: 500;
                    clicked => root.toggle-mosaic-loop-lock();
                }
            }
        }

        // Device Controls
        Rectangle {
            background: #1e3a5f33;
            border-width: 2px;
            border-radius: 6px;
            border-color: Theme.active.border-strong;
            GridLayout {
                padding-top: 30px;
                padding-right: 12px;
                padding-bottom: 12px;
                padding-left: 12px;
                spacing-horizontal: 10px;
                spacing-vertical: 30px;

                // Row 1 Controls
                Row {
                    // Wet
                    RDSKnob {
                        renderer: "lo-fi";
                        value: root.mosaic-wet;
                        min-value: 0; max-value: 1;
                        size: 70px; indicator-position: 25px;
                        label: "Wet";
                        label-pos: "top-center";
                        label-font-size: 10px;
                        label-font-weight: 500;
                        sensitivity: 0.01; scroll-sensitivity: 0.01;
                        value-changed(v) => { root.mosaic-wet = v; root.mosaic-wet-changed(v); }
                    }
                    // Pitch
                    RDSKnob {
                        renderer: "lo-fi";
                        value: root.mosaic-pitch;
                        min-value: 0; max-value: 1;
                        size: 70px; indicator-position: 25px;
                        label: "Pitch";
                        label-pos: "top-center";
                        label-font-size: 10px;
                        label-font-weight: 500;
                        sensitivity: 0.01; scroll-sensitivity: 0.01;
                        value-changed(v) => { root.mosaic-pitch = v; root.mosaic-pitch-changed(v); }
                    }
                    // Rate
                    RDSKnob {
                        renderer: "lo-fi";
                        value: root.mosaic-rate;
                        min-value: 0; max-value: 1;
                        size: 70px; indicator-position: 25px;
                        label: "Rate";
                        label-pos: "top-center";
                        label-font-size: 10px;
                        label-font-weight: 500;
                        readout-text: root.rate-readout;
                        sensitivity: 0.01; scroll-sensitivity: 0.01;
                        value-changed(v) => { root.mosaic-rate = v; root.mosaic-rate-changed(v); }
                    }
                    // Size
                    RDSKnob {
                        renderer: "lo-fi";
                        value: root.mosaic-size;
                        min-value: 0; max-value: 1;
                        size: 70px; indicator-position: 25px;
                        label: "Size";
                        label-pos: "top-center";
                        label-font-size: 10px;
                        label-font-weight: 500;
                        sensitivity: 0.01; scroll-sensitivity: 0.01;
                        value-changed(v) => { root.mosaic-size = v; root.mosaic-size-changed(v); }
                    }
                    // Contour
                    RDSKnob {
                        renderer: "lo-fi";
                        value: root.mosaic-contour;
                        min-value: 0; max-value: 1;
                        size: 70px; indicator-position: 25px;
                        label: "Contour";
                        label-pos: "top-center";
                        label-font-size: 10px;
                        label-font-weight: 500;
                        sensitivity: 0.01; scroll-sensitivity: 0.01;
                        value-changed(v) => { root.mosaic-contour = v; root.mosaic-contour-changed(v); }
                    }
                    // Warp
                    RDSKnob {
                        renderer: "lo-fi";
                        value: root.mosaic-warp;
                        min-value: 0; max-value: 1;
                        size: 70px; indicator-position: 25px;
                        label: "Warp";
                        label-pos: "top-center";
                        label-font-size: 10px;
                        label-font-weight: 500;
                        sensitivity: 0.01; scroll-sensitivity: 0.01;
                        value-changed(v) => { root.mosaic-warp = v; root.mosaic-warp-changed(v); }
                    }
                    // Spray
                    RDSKnob {
                        renderer: "lo-fi";
                        value: root.mosaic-spray;
                        min-value: 0; max-value: 1;
                        size: 70px; indicator-position: 25px;
                        label: "Spray";
                        label-pos: "top-center";
                        label-font-size: 10px;
                        label-font-weight: 500;
                        sensitivity: 0.01; scroll-sensitivity: 0.01;
                        value-changed(v) => { root.mosaic-spray = v; root.mosaic-spray-changed(v); }
                    }
                }

                // Row 2 Controls
                Row {
                    // Pattern
                    RDSKnob {
                        renderer: "lo-fi";
                        value: root.mosaic-pattern;
                        min-value: 0; max-value: 1;
                        size: 70px; indicator-position: 25px;
                        label: "Pattern";
                        label-pos: "top-center";
                        label-font-size: 10px;
                        label-font-weight: 500;
                        sensitivity: 0.01; scroll-sensitivity: 0.01;
                        value-changed(v) => { root.mosaic-pattern = v; root.mosaic-pattern-changed(v); }
                    }
                    // Detune
                    RDSKnob {
                        renderer: "lo-fi";
                        value: root.mosaic-detune;
                        min-value: 0; max-value: 1;
                        size: 70px; indicator-position: 25px;
                        label: "Detune";
                        label-pos: "top-center";
                        label-font-size: 10px;
                        label-font-weight: 500;
                        sensitivity: 0.01; scroll-sensitivity: 0.01;
                        value-changed(v) => { root.mosaic-detune = v; root.mosaic-detune-changed(v); }
                    }
                    // Spatial
                    RDSKnob {
                        renderer: "lo-fi";
                        value: root.mosaic-spatial;
                        min-value: 0; max-value: 1;
                        size: 70px; indicator-position: 25px;
                        label: "Spatial";
                        label-pos: "top-center";
                        label-font-size: 10px;
                        label-font-weight: 500;
                        sensitivity: 0.01; scroll-sensitivity: 0.01;
                        value-changed(v) => { root.mosaic-spatial = v; root.mosaic-spatial-changed(v); }
                    }
                    // Random Rate
                    RDSKnob {
                        renderer: "lo-fi";
                        value: root.mosaic-rand-rate;
                        min-value: 0; max-value: 1;
                        size: 70px; indicator-position: 25px;
                        label: "Rand Rate";
                        label-pos: "top-center";
                        label-font-size: 10px;
                        label-font-weight: 500;
                        sensitivity: 0.01; scroll-sensitivity: 0.01;
                        value-changed(v) => { root.mosaic-rand-rate = v; root.mosaic-rand-rate-changed(v); }
                    }
                    // Random Size
                    RDSKnob {
                        renderer: "lo-fi";
                        value: root.mosaic-rand-size;
                        min-value: 0; max-value: 1;
                        size: 70px; indicator-position: 25px;
                        label: "Rand Size";
                        label-pos: "top-center";
                        label-font-size: 10px;
                        label-font-weight: 500;
                        sensitivity: 0.01; scroll-sensitivity: 0.01;
                        value-changed(v) => { root.mosaic-rand-size = v; root.mosaic-rand-size-changed(v); }
                    }
                    // Sound-On-Sound (Overdub)
                    RDSKnob {
                        renderer: "lo-fi";
                        value: root.mosaic-sos;
                        min-value: 0; max-value: 1;
                        size: 70px; indicator-position: 25px;
                        label: "SOS";
                        label-pos: "top-center";
                        label-font-size: 10px;
                        label-font-weight: 500;
                        sensitivity: 0.01; scroll-sensitivity: 0.01;
                        value-changed(v) => { root.mosaic-sos = v; root.mosaic-sos-changed(v); }
                    }
                }
            }
        }
    }
}

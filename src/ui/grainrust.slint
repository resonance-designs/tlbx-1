/**
 * GrainRust - A Rust-based granular audio sampler.
 * Copyright (C) 2026 Richard Bakos @ Resonance Designs.
 * Author: Richard Bakos <info@resonancedesigns.dev>
 * Website: https://resonancedesigns.dev
 * Version: 0.1.6
 * Component: UI Definitions
 */

/**
 * GrainRust - A Rust-based granular audio sampler.
 * Copyright (C) 2026 Richard Bakos @ Resonance Designs.
 * Author: Richard Bakos <info@resonancedesigns.dev>
 * Website: https://resonancedesigns.dev
 * Version: 0.1.6
 * Component: UI Definitions
 */

import {
    Button,
    ComboBox,
    ScrollView
} from "std-widgets.slint";

import {
    RDSSelectButton,
    RDSSequencerCell,
    RDSVUMeter,
    RDSVertVUMeter,
    RDSSlider,
    RDSCircleToggle,
    RDSKnob
} from "./components/index.slint";

import { TapeEngine } from "./tape_engine.slint";

export component GrainRustUI inherits Window {
    in-out property <int> selected-track: 1;
    in-out property <bool> is-playing: false;
    in-out property <bool> is-recording: false;
    in-out property <float> gain: 0.5;
    in-out property <float> master-filter: 0.5;
    in-out property <float> master-comp: 0.0;
    in-out property <float> track-level: 1.0;
    in-out property <bool> track-muted: false;
    in-out property <float> meter-left: 0.0;
    in-out property <float> meter-right: 0.0;
    in-out property <float> track-meter-left: 0.0;
    in-out property <float> track-meter-right: 0.0;
    in-out property <float> tape-speed: 1.0;
    in-out property <float> tape-tempo: 120.0;
    in property <string> tempo-label;
    in property <[string]> tape-rate-modes;
    in-out property <int> tape-rate-mode: 0;
    in property <[string]> ring-decay-modes;
    in-out property <int> ring-decay-mode: 0;
    in property <[string]> ring-rate-modes;
    in-out property <int> ring-waves-rate-mode: 0;
    in-out property <int> ring-noise-rate-mode: 0;
    in property <[string]> ring-scale-modes;
    in-out property <int> ring-scale: 0;
    in-out property <float> tape-rotate: 0.0;
    in-out property <float> tape-glide: 0.0;
    in-out property <float> tape-sos: 0.0;
    in-out property <bool> tape-reverse: false;
    in-out property <bool> tape-freeze: false;
    in-out property <bool> tape-keylock: false;
    in-out property <bool> tape-monitor: false;
    in-out property <bool> tape-overdub: false;
    in-out property <float> mosaic-pitch: 0.0;
    in-out property <float> mosaic-rate: 0.5;
    in-out property <float> mosaic-size: 0.5;
    in-out property <float> mosaic-contour: 0.5;
    in-out property <float> mosaic-warp: 0.0;
    in-out property <float> mosaic-spray: 0.0;
    in-out property <float> mosaic-pattern: 0.0;
    in-out property <float> mosaic-wet: 0.0;
    in-out property <float> mosaic-detune: 0.0;
    in-out property <float> mosaic-spatial: 0.0;
    in-out property <float> mosaic-rand-rate: 0.0;
    in-out property <float> mosaic-rand-size: 0.0;
    in-out property <float> mosaic-sos: 0.0;
    in-out property <float> ring-cutoff: 0.5;
    in-out property <float> ring-resonance: 0.0;
    in-out property <float> ring-decay: 0.0;
    in-out property <float> ring-pitch: 0.5;
    in-out property <float> ring-tone: 0.5;
    in-out property <float> ring-tilt: 0.5;
    in-out property <float> ring-slope: 0.5;
    in-out property <float> ring-wet: 0.0;
    in-out property <float> ring-detune: 0.0;
    in-out property <float> ring-waves: 0.0;
    in-out property <float> ring-waves-rate: 0.5;
    in-out property <float> ring-noise: 0.0;
    in-out property <float> ring-noise-rate: 0.5;
    in-out property <float> loop-start: 0.0;
    in-out property <float> trigger-start: 0.0;
    in-out property <float> loop-length: 1.0;
    in-out property <float> loop-xfade: 0.0;
    in-out property <bool> loop-enabled: true;
    in property <[string]> loop-modes;
    in-out property <int> loop-mode: 0;
    in property <[string]> visualizer-modes;
    in-out property <int> visualizer-mode: 0;
    in property <[string]> waveform_time_labels;
    in property <[float]> oscilloscope;
    in property <[float]> spectrum;
    in property <[float]> vectorscope_x;
    in property <[float]> vectorscope_y;
    in property <[float]> waveform;
    in property <int> playhead-index: 0;
    in property <[string]> engine-types;
    in-out property <int> engine-index: 0;
    in-out property <bool> engine-loaded: false;
    in-out property <bool> mosaic-enabled: true;
    in-out property <bool> ring-enabled: false;
    in-out property <bool> metronome-enabled: false;
    in-out property <float> metronome-count-in: 0.0;
    in-out property <bool> metronome-count-playback: false;
    in-out property <bool> metronome-count-record: false;
    in property <string> metronome-count-in-label;
    in-out property <bool> show-engine-confirm: false;
    in property <string> engine-confirm-text;
    in property <int> active-engine-type: 0; // 1 = Tape, 2 = Animate
    in property <bool> is-software-renderer: false;

    // Animate Engine Properties
    in property <[string]> animate-slot-types;
    in-out property <int> animate-slot-a-type: 0;
    in-out property <int> animate-slot-b-type: 0;
    in-out property <int> animate-slot-c-type: 0;
    in-out property <int> animate-slot-d-type: 0;

    in property <[string]> animate-wavetables;
    in-out property <int> animate-slot-a-wavetable: 0;
    in-out property <int> animate-slot-b-wavetable: 0;
    in-out property <int> animate-slot-c-wavetable: 0;
    in-out property <int> animate-slot-d-wavetable: 0;

    in property <[string]> animate-samples;
    in-out property <int> animate-slot-a-sample: 0;
    in-out property <int> animate-slot-b-sample: 0;
    in-out property <int> animate-slot-c-sample: 0;
    in-out property <int> animate-slot-d-sample: 0;

    in-out property <float> animate-slot-a-coarse: 0.0;
    in-out property <float> animate-slot-a-fine: 0.0;
    in-out property <float> animate-slot-a-level: 1.0;
    in-out property <float> animate-slot-a-pan: 0.0;

    in-out property <float> animate-slot-b-coarse: 0.0;
    in-out property <float> animate-slot-b-fine: 0.0;
    in-out property <float> animate-slot-b-level: 1.0;
    in-out property <float> animate-slot-b-pan: 0.0;

    in-out property <float> animate-slot-c-coarse: 0.0;
    in-out property <float> animate-slot-c-fine: 0.0;
    in-out property <float> animate-slot-c-level: 1.0;
    in-out property <float> animate-slot-c-pan: 0.0;

    in-out property <float> animate-slot-d-coarse: 0.0;
    in-out property <float> animate-slot-d-fine: 0.0;
    in-out property <float> animate-slot-d-level: 1.0;
    in-out property <float> animate-slot-d-pan: 0.0;

    in-out property <float> animate-vector-x: 0.5;
    in-out property <float> animate-vector-y: 0.5;

    in-out property <float> animate-filter-cutoff: 0.5;
    in-out property <float> animate-filter-resonance: 0.5;
    in-out property <float> animate-filter-drive: 0.5;
    in property <[string]> animate-filter-types;
    in-out property <int> animate-filter-type: 0;

    in-out property <float> animate-amp-attack: 0.01;
    in-out property <float> animate-amp-decay: 0.1;
    in-out property <float> animate-amp-sustain: 0.8;
    in-out property <float> animate-amp-release: 0.3;

    in-out property <[bool]> animate-sequencer-grid; // Flat array rows * steps
    in property <int> animate-sequencer-steps: 16;
    in property <int> animate-sequencer-rows: 10;
    in property <int> animate-sequencer-current-step: -1;

    in-out property <bool> show-settings: false;
    in property <[string]> output-devices;
    in-out property <int> output-device-index: 0;
    in property <[string]> input-devices;
    in-out property <int> input-device-index: 0;
    in property <[string]> sample-rates;
    in-out property <int> sample-rate-index: 0;
    in property <[string]> buffer-sizes;
    in-out property <int> buffer-size-index: 0;
    in property <string> settings-status: "";

    callback select-track(track: int);
    callback toggle-play();
    callback audition-start();
    callback audition-end();
    callback toggle-record();
    callback load-sample();
    callback gain-changed(value: float);
    callback master-filter-changed(value: float);
    callback master-comp-changed(value: float);
    callback track-level-changed(value: float);
    callback toggle-track-mute();
    callback tape-speed-changed(value: float);
    callback tape-tempo-changed(value: float);
    callback tape-rate-mode-selected(index: int);
    callback tape-rotate-changed(value: float);
    callback tape-glide-changed(value: float);
    callback tape-sos-changed(value: float);
    callback toggle-tape-reverse();
    callback toggle-tape-freeze();
    callback toggle-tape-keylock();
    callback toggle-tape-monitor();
    callback toggle-tape-overdub();
    callback mosaic-pitch-changed(value: float);
    callback mosaic-rate-changed(value: float);
    callback mosaic-size-changed(value: float);
    callback mosaic-contour-changed(value: float);
    callback mosaic-warp-changed(value: float);
    callback mosaic-spray-changed(value: float);
    callback mosaic-pattern-changed(value: float);
    callback mosaic-wet-changed(value: float);
    callback mosaic-detune-changed(value: float);
    callback mosaic-spatial-changed(value: float);
    callback mosaic-rand-rate-changed(value: float);
    callback mosaic-rand-size-changed(value: float);
    callback mosaic-sos-changed(value: float);
    callback toggle-mosaic-enabled();
    callback ring-cutoff-changed(value: float);
    callback ring-resonance-changed(value: float);
    callback ring-decay-changed(value: float);
    callback ring-decay-mode-selected(index: int);
    callback ring-pitch-changed(value: float);
    callback ring-tone-changed(value: float);
    callback ring-tilt-changed(value: float);
    callback ring-slope-changed(value: float);
    callback ring-wet-changed(value: float);
    callback ring-detune-changed(value: float);
    callback ring-waves-changed(value: float);
    callback ring-waves-rate-changed(value: float);
    callback ring-waves-rate-mode-selected(index: int);
    callback ring-noise-changed(value: float);
    callback ring-noise-rate-changed(value: float);
    callback ring-noise-rate-mode-selected(index: int);
    callback ring-scale-selected(index: int);
    callback toggle-ring-enabled();
    callback toggle-metronome();
    callback metronome-count-in-changed(value: float);
    callback toggle-metronome-count-playback();
    callback toggle-metronome-count-record();
    callback save-sample();
    callback loop-start-changed(value: float);
    callback trigger-start-changed(value: float);
    callback loop-length-changed(value: float);
    callback loop-xfade-changed(value: float);
    callback toggle-loop-enabled();
    callback loop-mode-selected(index: int);
    callback visualizer-mode-selected(index: int);
    callback quit();
    callback toggle-settings();
    callback save-project();
    callback load-project();
    callback output-device-selected(index: int);
    callback input-device-selected(index: int);
    callback sample-rate-selected(index: int);
    callback buffer-size-selected(index: int);
    callback refresh-devices();
    callback apply-settings();
    callback load-engine();
    callback confirm-engine-load();
    callback cancel-engine-load();
    callback open-docs();

    // Animate Engine Callbacks
    callback animate-slot-a-type-changed(index: int);
    callback animate-slot-b-type-changed(index: int);
    callback animate-slot-c-type-changed(index: int);
    callback animate-slot-d-type-changed(index: int);

    callback animate-slot-a-wavetable-changed(index: int);
    callback animate-slot-b-wavetable-changed(index: int);
    callback animate-slot-c-wavetable-changed(index: int);
    callback animate-slot-d-wavetable-changed(index: int);

    callback animate-slot-a-sample-changed(index: int);
    callback animate-slot-b-sample-changed(index: int);
    callback animate-slot-c-sample-changed(index: int);
    callback animate-slot-d-sample-changed(index: int);

    callback animate-slot-a-coarse-changed(value: float);
    callback animate-slot-a-fine-changed(value: float);
    callback animate-slot-a-level-changed(value: float);
    callback animate-slot-a-pan-changed(value: float);

    callback animate-slot-b-coarse-changed(value: float);
    callback animate-slot-b-fine-changed(value: float);
    callback animate-slot-b-level-changed(value: float);
    callback animate-slot-b-pan-changed(value: float);

    callback animate-slot-c-coarse-changed(value: float);
    callback animate-slot-c-fine-changed(value: float);
    callback animate-slot-c-level-changed(value: float);
    callback animate-slot-c-pan-changed(value: float);

    callback animate-slot-d-coarse-changed(value: float);
    callback animate-slot-d-fine-changed(value: float);
    callback animate-slot-d-level-changed(value: float);
    callback animate-slot-d-pan-changed(value: float);

    callback animate-vector-changed(x: float, y: float);

    callback animate-filter-cutoff-changed(value: float);
    callback animate-filter-resonance-changed(value: float);
    callback animate-filter-drive-changed(value: float);
    callback animate-filter-type-changed(index: int);

    callback animate-amp-attack-changed(value: float);
    callback animate-amp-decay-changed(value: float);
    callback animate-amp-sustain-changed(value: float);
    callback animate-amp-release-changed(value: float);

    callback animate-sequencer-grid-toggled(row: int, step: int);

    background: #0f0f12;

    ScrollView {
        width: parent.width;
        height: parent.height;

        VerticalLayout {
            width: Math.min(parent.width, 1200px);
            x: (parent.width - self.width) / 2;
            padding: 12px;
            spacing: 8px;

            HorizontalLayout {
                width: parent.width;
                spacing: 16px;

            Text {
                text: "GrainRust";
                color: #f0f0f2;
                font-size: 24px;
                font-weight: 600;
            }

            VerticalLayout {
                spacing: 4px;
                width: 80px;
                alignment: center;
                Text {
                    text: "Filter";
                    color: #b9b9bf;
                    font-size: 10px;
                    horizontal-alignment: center;
                }
                RDSKnob {
                    renderer: "lo-fi";
                    value: root.master-filter;
                    min-value: 0;
                    max-value: 1;
                    size: 40px;
                    indicator-position: 12px;
                    sensitivity: 0.01;
                    scroll-sensitivity: 0.01;
                    value-changed(v) => {
                        root.master-filter = v;
                        root.master-filter-changed(v);
                    }
                }
            }

            VerticalLayout {
                spacing: 4px;
                width: 80px;
                alignment: center;
                Text {
                    text: "Comp";
                    color: #b9b9bf;
                    font-size: 10px;
                    horizontal-alignment: center;
                }
                RDSKnob {
                    renderer: "lo-fi";
                    value: root.master-comp;
                    min-value: 0;
                    max-value: 1;
                    size: 40px;
                    indicator-position: 12px;
                    sensitivity: 0.01;
                    scroll-sensitivity: 0.01;
                    value-changed(v) => {
                        root.master-comp = v;
                        root.master-comp-changed(v);
                    }
                }
            }

            VerticalLayout {
                spacing: 4px;
                width: 80px;
                alignment: center;
                Text {
                    text: "Master";
                    color: #b9b9bf;
                    font-size: 12px;
                    horizontal-alignment: center;
                }
                RDSKnob {
                    renderer: "lo-fi";
                    value: root.gain;
                    min-value: 0;
                    max-value: 1;
                    size: 64px;
                    indicator-position: 20px;
                    sensitivity: 0.01;
                    scroll-sensitivity: 0.01;
                    value-changed(v) => {
                        root.gain = v;
                        root.gain-changed(v);
                    }
                }
            }

            VerticalLayout {
                spacing: 4px;
                width: 80px;
                alignment: center;
                Text {
                    text: root.tempo-label;
                    color: #b9b9bf;
                    font-size: 12px;
                    horizontal-alignment: center;
                }
                RDSKnob {
                    renderer: "lo-fi";
                    value: root.tape-tempo;
                    min-value: 20;
                    max-value: 240;
                    size: 48px;
                    indicator-position: 15px;
                    sensitivity: 0.5;
                    scroll-sensitivity: 0.5;
                    value-changed(v) => {
                        root.tape-tempo = v;
                        root.tape-tempo-changed(v);
                    }
                }
            }

            VerticalLayout {
                spacing: 4px;
                width: 100px;
                alignment: center;
                Text {
                    text: "Transport";
                    color: #b9b9bf;
                    font-size: 12px;
                    horizontal-alignment: center;
                }
                HorizontalLayout {
                    spacing: 8px;
                    alignment: center;
                    Button { 
                        text: root.is-playing ? "Stop" : "Play"; 
                        width: 70px;
                        height: 32px;
                        clicked => root.toggle-play(); 
                    }
                }
            }

            Rectangle {
                width: 240px;
                height: 80px;
                background: #121216;
                border-radius: 6px;
                border-color: #2a2a35;
                border-width: 1px;
                VerticalLayout {
                    padding: 4px;
                    spacing: 4px;
                    HorizontalLayout {
                        spacing: 4px;
                        RDSCircleToggle {
                            active: root.visualizer-mode == 0;
                            clicked => { root.visualizer-mode = 0; root.visualizer-mode-selected(0); }
                        }
                        RDSCircleToggle {
                            active: root.visualizer-mode == 1;
                            clicked => { root.visualizer-mode = 1; root.visualizer-mode-selected(1); }
                        }
                        RDSCircleToggle {
                            active: root.visualizer-mode == 2;
                            clicked => { root.visualizer-mode = 2; root.visualizer-mode-selected(2); }
                        }
                        RDSCircleToggle {
                            active: root.visualizer-mode == 3;
                            clicked => { root.visualizer-mode = 3; root.visualizer-mode-selected(3); }
                        }
                        Text {
                            text: root.visualizer-modes[root.visualizer-mode];
                            color: #b9b9bf;
                            font-size: 10px;
                        }
                    }
                    Rectangle {
                        width: parent.width - 8px;
                        height: parent.height - 24px;
                        background: #0f0f14;
                        border-radius: 4px;
                        clip: true;

                        Rectangle {
                            width: parent.width;
                            height: parent.height;
                            visible: root.visualizer-mode == 0;
                            for sample[i] in root.oscilloscope : Rectangle {
                                width: 2px;
                                height: Math.max(2px, Math.abs(sample) * (parent.height - 4px));
                                x: i * (parent.width / root.oscilloscope.length);
                                y: (parent.height - self.height) / 2;
                                background: #7dd3fc;
                            }
                        }

                        Rectangle {
                            width: parent.width;
                            height: parent.height;
                            visible: root.visualizer-mode == 1;
                            for mag[i] in root.spectrum : Rectangle {
                                width: parent.width / root.spectrum.length;
                                height: Math.max(2px, mag * (parent.height - 4px));
                                x: i * (parent.width / root.spectrum.length);
                                y: parent.height - self.height;
                                background: #a78bfa;
                            }
                        }

                        Rectangle {
                            width: parent.width;
                            height: parent.height;
                            visible: root.visualizer-mode == 2;
                            for xval[i] in root.vectorscope_x : Rectangle {
                                width: 2px;
                                height: 2px;
                                x: ((xval * 0.5) + 0.5) * parent.width;
                                y: ((root.vectorscope_y[i] * -0.5) + 0.5) * parent.height;
                                background: #34d399;
                            }
                        }
                    }
                }
            }

            HorizontalLayout {
                spacing: 4px;
                alignment: center;
                RDSVertVUMeter { level: root.meter-left; fill-color: #34d399; height: 80px; }
                RDSVertVUMeter { level: root.meter-right; fill-color: #60a5fa; height: 80px; }
            }
        }

            HorizontalLayout {
                spacing: 8px;
                height: 28px;
                for track[i] in [0, 1, 2, 3] : RDSSelectButton {
                    label: "Track " + (i + 1);
                    active: (i + 1) == root.selected-track;
                    clicked => { root.select-track(i + 1); }
                }
                Rectangle { width: 1px; background: #2a2a35; }
                ComboBox {
                    model: root.engine-types;
                    current-index: root.engine-index;
                    selected => { root.engine-index = self.current-index; }
                }
                Button { text: "Load Engine"; clicked => root.load-engine(); }
                Rectangle { width: 1px; background: #2a2a35; }
            Button { text: "Save Project"; clicked => root.save-project(); }
            Button { text: "Load Project"; clicked => root.load-project(); }
            Button { text: "Settings"; clicked => root.toggle-settings(); }
            Button { text: "Docs"; clicked => root.open-docs(); }
            Button { text: "Quit"; clicked => root.quit(); }
        }


        VerticalLayout {
            visible: root.engine-loaded;
            spacing: 8px;
            width: parent.width;

            Text { 
                text: root.active-engine-type == 1 ? "Tape Engine" : "Animate Engine"; 
                color: #f0f0f2; 
                font-size: 15px; 
            }

            TapeEngine {
                visible: root.active-engine-type == 1;
                width: parent.width;
                is-recording: root.is-recording;
                track-level <=> root.track-level;
                track-meter-left: root.track-meter-left;
                track-meter-right: root.track-meter-right;
                waveform: root.waveform;
                waveform_time_labels: root.waveform_time_labels;
                playhead-index: root.playhead-index;
                tape-speed <=> root.tape-speed;
                tape-rotate <=> root.tape-rotate;
                trigger-start <=> root.trigger-start;
                loop-start <=> root.loop-start;
                loop-length <=> root.loop-length;
                tape-glide <=> root.tape-glide;
                tape-sos <=> root.tape-sos;
                loop-xfade <=> root.loop-xfade;
                tape-rate-modes: root.tape-rate-modes;
                tape-rate-mode <=> root.tape-rate-mode;
                loop-modes: root.loop-modes;
                loop-mode <=> root.loop-mode;
                track-muted <=> root.track-muted;
                loop-enabled <=> root.loop-enabled;
                tape-reverse <=> root.tape-reverse;
                tape-freeze <=> root.tape-freeze;
                tape-keylock <=> root.tape-keylock;
                tape-monitor <=> root.tape-monitor;
                tape-overdub <=> root.tape-overdub;
                mosaic-enabled <=> root.mosaic-enabled;
                mosaic-pitch <=> root.mosaic-pitch;
                mosaic-rate <=> root.mosaic-rate;
                mosaic-size <=> root.mosaic-size;
                mosaic-contour <=> root.mosaic-contour;
                mosaic-warp <=> root.mosaic-warp;
                mosaic-spray <=> root.mosaic-spray;
                mosaic-pattern <=> root.mosaic-pattern;
                mosaic-wet <=> root.mosaic-wet;
                mosaic-detune <=> root.mosaic-detune;
                mosaic-spatial <=> root.mosaic-spatial;
                mosaic-rand-rate <=> root.mosaic-rand-rate;
                mosaic-rand-size <=> root.mosaic-rand-size;
                mosaic-sos <=> root.mosaic-sos;
                ring-enabled <=> root.ring-enabled;
                ring-cutoff <=> root.ring-cutoff;
                ring-resonance <=> root.ring-resonance;
                ring-decay <=> root.ring-decay;
                ring-pitch <=> root.ring-pitch;
                ring-decay-modes: root.ring-decay-modes;
                ring-decay-mode <=> root.ring-decay-mode;
                ring-slope <=> root.ring-slope;
                ring-tone <=> root.ring-tone;
                ring-tilt <=> root.ring-tilt;
                ring-wet <=> root.ring-wet;
                ring-detune <=> root.ring-detune;
                ring-waves <=> root.ring-waves;
                ring-waves-rate <=> root.ring-waves-rate;
                ring-noise <=> root.ring-noise;
                ring-noise-rate <=> root.ring-noise-rate;
                load-sample => root.load-sample();
                save-sample => root.save-sample();
                toggle-record => root.toggle-record();
                audition-start => root.audition-start();
                audition-end => root.audition-end();
                track-level-changed(value) => { root.track-level-changed(value); }
                tape-speed-changed(value) => { root.tape-speed-changed(value); }
                tape-rotate-changed(value) => { root.tape-rotate-changed(value); }
                trigger-start-changed(value) => { root.trigger-start-changed(value); }
                loop-start-changed(value) => { root.loop-start-changed(value); }
                loop-length-changed(value) => { root.loop-length-changed(value); }
                tape-glide-changed(value) => { root.tape-glide-changed(value); }
                tape-sos-changed(value) => { root.tape-sos-changed(value); }
                loop-xfade-changed(value) => { root.loop-xfade-changed(value); }
                tape-rate-mode-selected(index) => { root.tape-rate-mode-selected(index); }
                loop-mode-selected(index) => { root.loop-mode-selected(index); }
                toggle-track-mute => root.toggle-track-mute();
                toggle-loop-enabled => root.toggle-loop-enabled();
                toggle-tape-reverse => root.toggle-tape-reverse();
                toggle-tape-freeze => root.toggle-tape-freeze();
                toggle-tape-keylock => root.toggle-tape-keylock();
                toggle-tape-monitor => root.toggle-tape-monitor();
                toggle-tape-overdub => root.toggle-tape-overdub();
                toggle-mosaic-enabled => root.toggle-mosaic-enabled();
                mosaic-pitch-changed(value) => { root.mosaic-pitch-changed(value); }
                mosaic-rate-changed(value) => { root.mosaic-rate-changed(value); }
                mosaic-size-changed(value) => { root.mosaic-size-changed(value); }
                mosaic-contour-changed(value) => { root.mosaic-contour-changed(value); }
                mosaic-warp-changed(value) => { root.mosaic-warp-changed(value); }
                mosaic-spray-changed(value) => { root.mosaic-spray-changed(value); }
                mosaic-pattern-changed(value) => { root.mosaic-pattern-changed(value); }
                mosaic-wet-changed(value) => { root.mosaic-wet-changed(value); }
                mosaic-detune-changed(value) => { root.mosaic-detune-changed(value); }
                mosaic-spatial-changed(value) => { root.mosaic-spatial-changed(value); }
                mosaic-rand-rate-changed(value) => { root.mosaic-rand-rate-changed(value); }
                mosaic-rand-size-changed(value) => { root.mosaic-rand-size-changed(value); }
                mosaic-sos-changed(value) => { root.mosaic-sos-changed(value); }
                toggle-ring-enabled => root.toggle-ring-enabled();
                ring-cutoff-changed(value) => { root.ring-cutoff-changed(value); }
                ring-resonance-changed(value) => { root.ring-resonance-changed(value); }
                ring-decay-changed(value) => { root.ring-decay-changed(value); }
                ring-pitch-changed(value) => { root.ring-pitch-changed(value); }
                ring-decay-mode-selected(index) => { root.ring-decay-mode-selected(index); }
                ring-slope-changed(value) => { root.ring-slope-changed(value); }
                ring-tone-changed(value) => { root.ring-tone-changed(value); }
                ring-tilt-changed(value) => { root.ring-tilt-changed(value); }
                ring-wet-changed(value) => { root.ring-wet-changed(value); }
                ring-detune-changed(value) => { root.ring-detune-changed(value); }
                ring-waves-changed(value) => { root.ring-waves-changed(value); }
                ring-waves-rate-changed(value) => { root.ring-waves-rate-changed(value); }
                ring-noise-changed(value) => { root.ring-noise-changed(value); }
                ring-noise-rate-changed(value) => { root.ring-noise-rate-changed(value); }
            }

        VerticalLayout {
            visible: root.active-engine-type == 2;
                spacing: 12px;
                Text { text: "Animate Engine"; color: #f0f0f2; font-size: 15px; }

                HorizontalLayout {
                    spacing: 16px;
                    width: parent.width;

                    // Slot controls
                    VerticalLayout {
                        spacing: 8px;
                        width: (parent.width - 200px);

                        // Slot A
                        HorizontalLayout {
                            spacing: 8px;
                            Text { text: "Slot A"; color: #f6f1ff; font-size: 13px; width: 50px; vertical-alignment: center; }
                            ComboBox {
                                width: 100px;
                                model: root.animate-slot-types;
                                current-index: root.animate-slot-a-type;
                                selected => { root.animate-slot-a-type = self.current-index; root.animate-slot-a-type-changed(self.current-index); }
                            }
                            ComboBox {
                                width: 150px;
                                model: root.animate-slot-a-type == 0 ? root.animate-wavetables : root.animate-samples;
                                current-index: root.animate-slot-a-type == 0 ? root.animate-slot-a-wavetable : root.animate-slot-a-sample;
                                selected => {
                                    if (root.animate-slot-a-type == 0) {
                                        root.animate-slot-a-wavetable = self.current-index;
                                        root.animate-slot-a-wavetable-changed(self.current-index);
                                    } else {
                                        root.animate-slot-a-sample = self.current-index;
                                        root.animate-slot-a-sample-changed(self.current-index);
                                    }
                                }
                            }
                            VerticalLayout {
                                spacing: 4px;
                                width: 60px;
                                Text { text: "Level"; color: #b9b9bf; font-size: 11px; horizontal-alignment: center; }
                                RDSKnob {
                                    renderer: "lo-fi";
                                    value: root.animate-slot-a-level;
                                    min-value: 0; max-value: 1;
                                    size: 32px; indicator-position: 10px;
                                    sensitivity: 0.01; scroll-sensitivity: 0.01;
                                    value-changed(v) => { root.animate-slot-a-level = v; root.animate-slot-a-level-changed(v); }
                                }
                            }
                        }
                        // Slot B
                        HorizontalLayout {
                            spacing: 8px;
                            Text { text: "Slot B"; color: #f6f1ff; font-size: 13px; width: 50px; vertical-alignment: center; }
                            ComboBox {
                                width: 100px;
                                model: root.animate-slot-types;
                                current-index: root.animate-slot-b-type;
                                selected => { root.animate-slot-b-type = self.current-index; root.animate-slot-b-type-changed(self.current-index); }
                            }
                            ComboBox {
                                width: 150px;
                                model: root.animate-slot-b-type == 0 ? root.animate-wavetables : root.animate-samples;
                                current-index: root.animate-slot-b-type == 0 ? root.animate-slot-b-wavetable : root.animate-slot-b-sample;
                                selected => {
                                    if (root.animate-slot-b-type == 0) {
                                        root.animate-slot-b-wavetable = self.current-index;
                                        root.animate-slot-b-wavetable-changed(self.current-index);
                                    } else {
                                        root.animate-slot-b-sample = self.current-index;
                                        root.animate-slot-b-sample-changed(self.current-index);
                                    }
                                }
                            }
                            VerticalLayout {
                                spacing: 4px;
                                width: 60px;
                                Text { text: "Level"; color: #b9b9bf; font-size: 11px; horizontal-alignment: center; }
                                RDSKnob {
                                    renderer: "lo-fi";
                                    value: root.animate-slot-b-level;
                                    min-value: 0; max-value: 1;
                                    size: 32px; indicator-position: 10px;
                                    sensitivity: 0.01; scroll-sensitivity: 0.01;
                                    value-changed(v) => { root.animate-slot-b-level = v; root.animate-slot-b-level-changed(v); }
                                }
                            }
                        }
                        // Slot C
                        HorizontalLayout {
                            spacing: 8px;
                            Text { text: "Slot C"; color: #f6f1ff; font-size: 13px; width: 50px; vertical-alignment: center; }
                            ComboBox {
                                width: 100px;
                                model: root.animate-slot-types;
                                current-index: root.animate-slot-c-type;
                                selected => { root.animate-slot-c-type = self.current-index; root.animate-slot-c-type-changed(self.current-index); }
                            }
                            ComboBox {
                                width: 150px;
                                model: root.animate-slot-c-type == 0 ? root.animate-wavetables : root.animate-samples;
                                current-index: root.animate-slot-c-type == 0 ? root.animate-slot-c-wavetable : root.animate-slot-c-sample;
                                selected => {
                                    if (root.animate-slot-c-type == 0) {
                                        root.animate-slot-c-wavetable = self.current-index;
                                        root.animate-slot-c-wavetable-changed(self.current-index);
                                    } else {
                                        root.animate-slot-c-sample = self.current-index;
                                        root.animate-slot-c-sample-changed(self.current-index);
                                    }
                                }
                            }
                            VerticalLayout {
                                spacing: 4px;
                                width: 60px;
                                Text { text: "Level"; color: #b9b9bf; font-size: 11px; horizontal-alignment: center; }
                                RDSKnob {
                                    renderer: "lo-fi";
                                    value: root.animate-slot-c-level;
                                    min-value: 0; max-value: 1;
                                    size: 32px; indicator-position: 10px;
                                    sensitivity: 0.01; scroll-sensitivity: 0.01;
                                    value-changed(v) => { root.animate-slot-c-level = v; root.animate-slot-c-level-changed(v); }
                                }
                            }
                        }
                        // Slot D
                        HorizontalLayout {
                            spacing: 8px;
                            Text { text: "Slot D"; color: #f6f1ff; font-size: 13px; width: 50px; vertical-alignment: center; }
                            ComboBox {
                                width: 100px;
                                model: root.animate-slot-types;
                                current-index: root.animate-slot-d-type;
                                selected => { root.animate-slot-d-type = self.current-index; root.animate-slot-d-type-changed(self.current-index); }
                            }
                            ComboBox {
                                width: 150px;
                                model: root.animate-slot-d-type == 0 ? root.animate-wavetables : root.animate-samples;
                                current-index: root.animate-slot-d-type == 0 ? root.animate-slot-d-wavetable : root.animate-slot-d-sample;
                                selected => {
                                    if (root.animate-slot-d-type == 0) {
                                        root.animate-slot-d-wavetable = self.current-index;
                                        root.animate-slot-d-wavetable-changed(self.current-index);
                                    } else {
                                        root.animate-slot-d-sample = self.current-index;
                                        root.animate-slot-d-sample-changed(self.current-index);
                                    }
                                }
                            }
                            VerticalLayout {
                                spacing: 4px;
                                width: 60px;
                                Text { text: "Level"; color: #b9b9bf; font-size: 11px; horizontal-alignment: center; }
                                RDSKnob {
                                    renderer: "lo-fi";
                                    value: root.animate-slot-d-level;
                                    min-value: 0; max-value: 1;
                                    size: 32px; indicator-position: 10px;
                                    sensitivity: 0.01; scroll-sensitivity: 0.01;
                                    value-changed(v) => { root.animate-slot-d-level = v; root.animate-slot-d-level-changed(v); }
                                }
                            }
                        }
                    }

                    // Vector XY pad
                    Rectangle {
                        width: 160px;
                        height: 160px;
                        background: #1a1a22;
                        border-radius: 4px;
                        border-color: #3a3a45;
                        border-width: 1px;

                        Rectangle {
                            width: 12px; height: 12px;
                            background: #c53bff;
                            border-radius: 6px;
                            x: root.animate-vector-x * (parent.width - 12px);
                            y: (1.0 - root.animate-vector-y) * (parent.height - 12px);
                        }

                        TouchArea {
                            moved => {
                                root.animate-vector-x = Math.max(0.0, Math.min(1.0, self.mouse-x / parent.width));
                                root.animate-vector-y = 1.0 - Math.max(0.0, Math.min(1.0, self.mouse-y / parent.height));
                                root.animate-vector-changed(root.animate-vector-x, root.animate-vector-y);
                            }
                            clicked => {
                                root.animate-vector-x = Math.max(0.0, Math.min(1.0, self.mouse-x / parent.width));
                                root.animate-vector-y = 1.0 - Math.max(0.0, Math.min(1.0, self.mouse-y / parent.height));
                                root.animate-vector-changed(root.animate-vector-x, root.animate-vector-y);
                            }
                        }
                    }
                }

                HorizontalLayout {
                    spacing: 16px;

                    VerticalLayout {
                        spacing: 6px;
                        Text { text: "Filter"; color: #e4e4ea; font-size: 14px; }
                        HorizontalLayout {
                            spacing: 12px;
                            VerticalLayout {
                                spacing: 4px;
                                width: 50px;
                                Text { text: "Cutoff"; color: #b9b9bf; font-size: 11px; horizontal-alignment: center; }
                                RDSKnob {
                                    renderer: "lo-fi";
                                    value: root.animate-filter-cutoff;
                                    min-value: 0; max-value: 1;
                                    size: 36px; indicator-position: 12px;
                                    sensitivity: 0.01; scroll-sensitivity: 0.01;
                                    value-changed(v) => { root.animate-filter-cutoff = v; root.animate-filter-cutoff-changed(v); }
                                }
                            }
                            VerticalLayout {
                                spacing: 4px;
                                width: 50px;
                                Text { text: "Res"; color: #b9b9bf; font-size: 11px; horizontal-alignment: center; }
                                RDSKnob {
                                    renderer: "lo-fi";
                                    value: root.animate-filter-resonance;
                                    min-value: 0; max-value: 1;
                                    size: 36px; indicator-position: 12px;
                                    sensitivity: 0.01; scroll-sensitivity: 0.01;
                                    value-changed(v) => { root.animate-filter-resonance = v; root.animate-filter-resonance-changed(v); }
                                }
                            }
                            VerticalLayout {
                                spacing: 4px;
                                width: 50px;
                                Text { text: "Drive"; color: #b9b9bf; font-size: 11px; horizontal-alignment: center; }
                                RDSKnob {
                                    renderer: "lo-fi";
                                    value: root.animate-filter-drive;
                                    min-value: 0; max-value: 1;
                                    size: 36px; indicator-position: 12px;
                                    sensitivity: 0.01; scroll-sensitivity: 0.01;
                                    value-changed(v) => { root.animate-filter-drive = v; root.animate-filter-drive-changed(v); }
                                }
                            }
                            ComboBox {
                                width: 100px;
                                model: root.animate-filter-types;
                                current-index: root.animate-filter-type;
                                selected => { root.animate-filter-type = self.current-index; root.animate-filter-type-changed(self.current-index); }
                            }
                        }
                    }

                    VerticalLayout {
                        spacing: 6px;
                        Text { text: "Amp Envelope"; color: #e4e4ea; font-size: 14px; }
                        HorizontalLayout {
                            spacing: 12px;
                            VerticalLayout {
                                spacing: 4px;
                                width: 40px;
                                Text { text: "A"; color: #b9b9bf; font-size: 11px; horizontal-alignment: center; }
                                RDSKnob {
                                    renderer: "lo-fi";
                                    value: root.animate-amp-attack;
                                    min-value: 0.01; max-value: 1;
                                    size: 28px; indicator-position: 8px;
                                    sensitivity: 0.01; scroll-sensitivity: 0.01;
                                    value-changed(v) => { root.animate-amp-attack = v; root.animate-amp-attack-changed(v); }
                                }
                            }
                            VerticalLayout {
                                spacing: 4px;
                                width: 40px;
                                Text { text: "D"; color: #b9b9bf; font-size: 11px; horizontal-alignment: center; }
                                RDSKnob {
                                    renderer: "lo-fi";
                                    value: root.animate-amp-decay;
                                    min-value: 0.01; max-value: 1;
                                    size: 28px; indicator-position: 8px;
                                    sensitivity: 0.01; scroll-sensitivity: 0.01;
                                    value-changed(v) => { root.animate-amp-decay = v; root.animate-amp-decay-changed(v); }
                                }
                            }
                            VerticalLayout {
                                spacing: 4px;
                                width: 40px;
                                Text { text: "S"; color: #b9b9bf; font-size: 11px; horizontal-alignment: center; }
                                RDSKnob {
                                    renderer: "lo-fi";
                                    value: root.animate-amp-sustain;
                                    min-value: 0; max-value: 1;
                                    size: 28px; indicator-position: 8px;
                                    sensitivity: 0.01; scroll-sensitivity: 0.01;
                                    value-changed(v) => { root.animate-amp-sustain = v; root.animate-amp-sustain-changed(v); }
                                }
                            }
                            VerticalLayout {
                                spacing: 4px;
                                width: 40px;
                                Text { text: "R"; color: #b9b9bf; font-size: 11px; horizontal-alignment: center; }
                                RDSKnob {
                                    renderer: "lo-fi";
                                    value: root.animate-amp-release;
                                    min-value: 0.01; max-value: 1;
                                    size: 28px; indicator-position: 8px;
                                    sensitivity: 0.01; scroll-sensitivity: 0.01;
                                    value-changed(v) => { root.animate-amp-release = v; root.animate-amp-release-changed(v); }
                                }
                            }
                        }
                    }
                }

                VerticalLayout {
                    spacing: 4px;
                    Text { text: "Sequencer"; color: #e4e4ea; font-size: 14px; }
                    for r in [0, 1, 2, 3, 4, 5, 6, 7, 8, 9] : HorizontalLayout {
                        spacing: 2px;
                        for s in [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15] : RDSSequencerCell {
                            active: root.animate-sequencer-grid[r * 16 + s];
                            current: s == root.animate-sequencer-current-step;
                            clicked => { root.animate-sequencer-grid-toggled(r, s); }
                        }
                    }
                }
            }
        }

        }
    }

    Rectangle {
        visible: root.show-settings;
        width: parent.width;
        height: parent.height;
        background: #00000080;

        Rectangle {
            width: Math.min(520px, parent.width - 40px);
            height: Math.min(520px, parent.height - 40px);
            x: (parent.width - self.width) / 2;
            y: (parent.height - self.height) / 2;
            background: #15151c;
            border-color: #2a2a35;
            border-width: 1px;
            border-radius: 8px;

            VerticalLayout {
                padding: 16px;
                spacing: 10px;

                HorizontalLayout {
                    spacing: 8px;
                    Text {
                        text: "Audio Settings";
                        color: #e4e4ea;
                        font-size: 16px;
                        horizontal-stretch: 1;
                    }
                    Button {
                        text: "Close";
                        clicked => root.toggle-settings();
                    }
                }

                HorizontalLayout {
                    spacing: 8px;
                    Text { text: "Output device"; color: #9c9ca4; font-size: 13px; width: 110px; vertical-alignment: center; }
                    ComboBox {
                        model: root.output-devices;
                        current-index: root.output-device-index;
                        selected => { root.output-device-selected(self.current-index); }
                    }
                }

                HorizontalLayout {
                    spacing: 8px;
                    Text { text: "Input device"; color: #9c9ca4; font-size: 13px; width: 110px; vertical-alignment: center; }
                    ComboBox {
                        model: root.input-devices;
                        current-index: root.input-device-index;
                        selected => { root.input-device-selected(self.current-index); }
                    }
                }

                HorizontalLayout {
                    spacing: 8px;
                    Text { text: "Sample rate"; color: #9c9ca4; font-size: 13px; width: 110px; vertical-alignment: center; }
                    ComboBox {
                        model: root.sample-rates;
                        current-index: root.sample-rate-index;
                        selected => { root.sample-rate-selected(self.current-index); }
                    }
                }

                HorizontalLayout {
                    spacing: 8px;
                    Text { text: "Buffer size"; color: #9c9ca4; font-size: 13px; width: 110px; vertical-alignment: center; }
                    ComboBox {
                        model: root.buffer-sizes;
                        current-index: root.buffer-size-index;
                        selected => { root.buffer-size-selected(self.current-index); }
                    }
                }

                Text { text: "Metronome"; color: #e4e4ea; font-size: 15px; }

                HorizontalLayout {
                    spacing: 8px;
                    Button {
                        text: root.metronome-enabled ? "Metronome On" : "Metronome Off";
                        clicked => root.toggle-metronome();
                    }
                }

                HorizontalLayout {
                    spacing: 8px;
                    Text { text: root.metronome-count-in-label; color: #9c9ca4; font-size: 13px; width: 110px; vertical-alignment: center; }
                    RDSKnob {
                        renderer: "lo-fi";
                        value: root.metronome-count-in;
                        min-value: 0;
                        max-value: 8;
                        size: 32px;
                        indicator-position: 10px;
                        sensitivity: 0.1;
                        scroll-sensitivity: 0.1;
                        value-changed(v) => {
                            root.metronome-count-in = v;
                            root.metronome-count-in-changed(v);
                        }
                    }
                }

                HorizontalLayout {
                    spacing: 8px;
                    Button {
                        text: root.metronome-count-playback ? "Count-In Playback On" : "Count-In Playback Off";
                        clicked => root.toggle-metronome-count-playback();
                    }
                    Button {
                        text: root.metronome-count-record ? "Count-In Record On" : "Count-In Record Off";
                        clicked => root.toggle-metronome-count-record();
                    }
                }

                HorizontalLayout {
                    spacing: 8px;
                    Button { text: "Refresh Devices"; clicked => root.refresh-devices(); }
                    Button { text: "Apply & Restart"; clicked => root.apply-settings(); }
                }

                Text {
                    text: root.settings-status;
                    color: #d0a7ff;
                    font-size: 12px;
                }
            }
        }
    }

    Rectangle {
        visible: root.show-engine-confirm;
        width: parent.width;
        height: parent.height;
        background: #00000080;

        Rectangle {
            width: Math.min(420px, parent.width - 40px);
            height: 180px;
            x: (parent.width - self.width) / 2;
            y: (parent.height - self.height) / 2;
            background: #15151c;
            border-color: #2a2a35;
            border-width: 1px;
            border-radius: 8px;

            VerticalLayout {
                padding: 16px;
                spacing: 12px;
                Text {
                    text: "Replace engine?";
                    color: #f0f0f2;
                    font-size: 16px;
                }
                Text {
                    text: root.engine-confirm-text;
                    color: #b9b9bf;
                    font-size: 12px;
                }
                HorizontalLayout {
                    spacing: 8px;
                    Button { text: "Cancel"; clicked => root.cancel-engine-load(); }
                    Button { text: "Proceed to load..."; clicked => root.confirm-engine-load(); }
                }
            }
        }
    }
}

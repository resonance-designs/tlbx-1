import { Button, Slider, ComboBox, ScrollView } from "std-widgets.slint";

component TrackButton {
    in property <string> label;
    in property <bool> active;
    callback clicked();

    width: 80px;
    height: 28px;

    Rectangle {
        width: parent.width;
        height: parent.height;
        background: root.active ? #8023d6 : #1c1c22;
        border-radius: 6px;
        border-color: root.active ? #b07cff : #2a2a35;
        border-width: 1px;

        Text {
            text: root.label;
            color: #f6f1ff;
            font-size: 12px;
            horizontal-alignment: center;
            vertical-alignment: center;
        }

        TouchArea {
            clicked => root.clicked();
        }
    }
}

export component GrainRustUI inherits Window {
    in-out property <int> selected-track: 1;
    in-out property <bool> is-playing: false;
    in-out property <bool> is-recording: false;
    in-out property <float> gain: 0.5;
    in-out property <float> track-level: 1.0;
    in-out property <bool> track-muted: false;
    in-out property <float> loop-start: 0.0;
    in-out property <float> loop-length: 1.0;
    in-out property <float> loop-xfade: 0.0;
    in-out property <bool> loop-enabled: true;
    in property <[float]> waveform;
    in property <int> playhead-index: 0;

    in-out property <bool> show-settings: false;
    in property <[string]> output-devices;
    in-out property <int> output-device-index: 0;
    in property <[string]> sample-rates;
    in-out property <int> sample-rate-index: 0;
    in property <[string]> buffer-sizes;
    in-out property <int> buffer-size-index: 0;
    in property <string> settings-status: "";

    callback select-track(track: int);
    callback toggle-play();
    callback toggle-record();
    callback load-sample();
    callback gain-changed(value: float);
    callback track-level-changed(value: float);
    callback toggle-track-mute();
    callback loop-start-changed(value: float);
    callback loop-length-changed(value: float);
    callback loop-xfade-changed(value: float);
    callback toggle-loop-enabled();
    callback quit();
    callback toggle-settings();
    callback save-project();
    callback load-project();
    callback output-device-selected(index: int);
    callback sample-rate-selected(index: int);
    callback buffer-size-selected(index: int);
    callback refresh-devices();
    callback apply-settings();

    background: #0f0f12;

    ScrollView {
        width: parent.width;
        height: parent.height;

        VerticalLayout {
            padding: 12px;
            spacing: 8px;

        Text {
            text: "GrainRust";
            color: #f0f0f2;
            font-size: 24px;
            font-weight: 600;
        }

        Text {
            text: "Active Track: " + root.selected-track;
            color: #b9b9bf;
            font-size: 16px;
        }

        HorizontalLayout {
            spacing: 8px;
            for track[i] in [0, 1, 2, 3] : TrackButton {
                label: "Track " + (i + 1);
                active: (i + 1) == root.selected-track;
                clicked => { root.select-track(i + 1); }
            }
        }

        Rectangle {
            height: 120px;
            background: #121216;
            border-radius: 6px;
            border-color: #2a2a35;
            border-width: 1px;
            HorizontalLayout {
                padding: 8px;
                spacing: 3px;
                for amp[index] in root.waveform : Rectangle {
                    width: 4px;
                    height: parent.height;
                    background: transparent;
                    Rectangle {
                        width: parent.width;
                        height: Math.max(2px, Math.abs(amp) * (parent.height - 4px));
                        y: (parent.height - self.height) / 2;
                        background: index < root.playhead-index ? #c53bff : #4a0d7a;
                        border-radius: 1px;
                    }
                }
            }
        }

        HorizontalLayout {
            spacing: 16px;

            VerticalLayout {
                spacing: 6px;

                Text {
                    text: "Master Gain";
                    color: #b9b9bf;
                    font-size: 13px;
                }

                Slider {
                    value: root.gain;
                    minimum: 0;
                    maximum: 1;
                    changed => {
                        root.gain = self.value;
                        root.gain-changed(self.value);
                    }
                }

                Text {
                    text: "Track Level";
                    color: #b9b9bf;
                    font-size: 13px;
                }

                Slider {
                    value: root.track-level;
                    minimum: 0;
                    maximum: 1;
                    changed => {
                        root.track-level = self.value;
                        root.track-level-changed(self.value);
                    }
                }

                HorizontalLayout {
                    spacing: 8px;
                    Button {
                        text: root.track-muted ? "Unmute" : "Mute";
                        clicked => root.toggle-track-mute();
                    }
                    Button {
                        text: root.loop-enabled ? "Loop On" : "Loop Off";
                        clicked => root.toggle-loop-enabled();
                    }
                }
            }

            VerticalLayout {
                spacing: 6px;

                Text {
                    text: "Loop Start";
                    color: #b9b9bf;
                    font-size: 13px;
                }

                Slider {
                    value: root.loop-start;
                    minimum: 0;
                    maximum: 1;
                    changed => {
                        root.loop-start = self.value;
                        root.loop-start-changed(self.value);
                    }
                }

                Text {
                    text: "Loop Length";
                    color: #b9b9bf;
                    font-size: 13px;
                }

                Slider {
                    value: root.loop-length;
                    minimum: 0.01;
                    maximum: 1;
                    changed => {
                        root.loop-length = self.value;
                        root.loop-length-changed(self.value);
                    }
                }

                Text {
                    text: "Loop XFade";
                    color: #b9b9bf;
                    font-size: 13px;
                }

                Slider {
                    value: root.loop-xfade;
                    minimum: 0;
                    maximum: 0.5;
                    changed => {
                        root.loop-xfade = self.value;
                        root.loop-xfade-changed(self.value);
                    }
                }
            }
        }

        HorizontalLayout {
            spacing: 8px;
            Button { text: "Load Sample"; clicked => root.load-sample(); }
            Button { text: root.is-recording ? "Stop Record" : "Record"; clicked => root.toggle-record(); }
            Button { text: root.is-playing ? "Stop" : "Play"; clicked => root.toggle-play(); }
            Button { text: "Settings"; clicked => root.toggle-settings(); }
            Button { text: "Quit"; clicked => root.quit(); }
        }

        HorizontalLayout {
            spacing: 8px;
            Button { text: "Save Project"; clicked => root.save-project(); }
            Button { text: "Load Project"; clicked => root.load-project(); }
        }

            Rectangle {
                visible: root.show-settings;
                background: #15151c;
                border-color: #2a2a35;
                border-width: 1px;
                border-radius: 6px;
                padding: 12px;
                VerticalLayout {
                    spacing: 8px;

                    Text { text: "Audio Settings"; color: #e4e4ea; font-size: 16px; }

                    Text { text: "Output device"; color: #9c9ca4; font-size: 13px; }
                    ComboBox {
                        model: root.output-devices;
                        current-index: root.output-device-index;
                        selected => { root.output-device-selected(self.current-index); }
                    }

                    Text { text: "Sample rate"; color: #9c9ca4; font-size: 13px; }
                    ComboBox {
                        model: root.sample-rates;
                        current-index: root.sample-rate-index;
                        selected => { root.sample-rate-selected(self.current-index); }
                    }

                    Text { text: "Buffer size"; color: #9c9ca4; font-size: 13px; }
                    ComboBox {
                        model: root.buffer-sizes;
                        current-index: root.buffer-size-index;
                        selected => { root.buffer-size-selected(self.current-index); }
                    }

                    HorizontalLayout {
                        spacing: 8px;
                        Button { text: "Refresh Devices"; clicked => root.refresh-devices(); }
                        Button { text: "Apply & Restart"; clicked => root.apply-settings(); }
                    }

                    Text {
                        text: root.settings-status;
                        color: #d0a7ff;
                        font-size: 12px;
                    }
                }
            }
        }
    }
}

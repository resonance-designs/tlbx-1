import { Button, Slider, ComboBox, ScrollView } from "std-widgets.slint";

component TrackButton {
    in property <string> label;
    in property <bool> active;
    callback clicked();

    width: 80px;
    height: 28px;

    Rectangle {
        width: parent.width;
        height: parent.height;
        background: root.active ? #8023d6 : #1c1c22;
        border-radius: 6px;
        border-color: root.active ? #b07cff : #2a2a35;
        border-width: 1px;

        Text {
            text: root.label;
            color: #f6f1ff;
            font-size: 12px;
            horizontal-alignment: center;
            vertical-alignment: center;
        }

        TouchArea {
            clicked => root.clicked();
        }
    }

}

component VUMeter {
    in property <float> level;
    in property <color> fill-color;

    width: 140px;
    height: 10px;

    Rectangle {
        width: parent.width;
        height: parent.height;
        background: #1a1a22;
        border-radius: 4px;
        border-color: #2a2a35;
        border-width: 1px;

        Rectangle {
            width: Math.max(4px, root.level * parent.width);
            height: parent.height;
            background: root.fill-color;
            border-radius: 4px;
        }
    }
}
component VerticalVUMeter {
    in property <float> level;
    in property <color> fill-color;

    width: 12px;
    height: 88px;

    Rectangle {
        width: parent.width;
        height: parent.height;
        background: #1a1a22;
        border-radius: 4px;
        border-color: #2a2a35;
        border-width: 1px;

        Rectangle {
            width: parent.width;
            height: Math.max(2px, root.level * parent.height);
            y: parent.height - self.height;
            background: root.fill-color;
            border-radius: 4px;
        }
    }
}

component VizToggle {
    in property <bool> active;
    callback clicked();

    width: 14px;
    height: 14px;

    Rectangle {
        width: parent.width;
        height: parent.height;
        background: root.active ? #c53bff : #2a2a35;
        border-radius: 999px;
        border-color: root.active ? #e3c1ff : #3a3a45;
        border-width: 1px;

        TouchArea {
            clicked => root.clicked();
        }
    }
}

export component GrainRustUI inherits Window {
    in-out property <int> selected-track: 1;
    in-out property <bool> is-playing: false;
    in-out property <bool> is-recording: false;
    in-out property <float> gain: 0.5;
    in-out property <float> track-level: 1.0;
    in-out property <bool> track-muted: false;
    in-out property <float> meter-left: 0.0;
    in-out property <float> meter-right: 0.0;
    in-out property <float> track-meter-left: 0.0;
    in-out property <float> track-meter-right: 0.0;
    in-out property <float> tape-speed: 1.0;
    in-out property <float> tape-tempo: 120.0;
    in property <[string]> tape-rate-modes;
    in-out property <int> tape-rate-mode: 0;
    in-out property <float> tape-rotate: 0.0;
    in-out property <float> tape-glide: 0.0;
    in-out property <float> tape-sos: 0.0;
    in-out property <bool> tape-reverse: false;
    in-out property <bool> tape-freeze: false;
    in-out property <bool> tape-keylock: false;
    in-out property <bool> tape-monitor: false;
    in-out property <bool> tape-overdub: false;
    in-out property <float> loop-start: 0.0;
    in-out property <float> loop-length: 1.0;
    in-out property <float> loop-xfade: 0.0;
    in-out property <bool> loop-enabled: true;
    in property <[string]> loop-modes;
    in-out property <int> loop-mode: 0;
    in property <[string]> visualizer-modes;
    in-out property <int> visualizer-mode: 0;
    in property <[string]> waveform_time_labels;
    in property <[float]> oscilloscope;
    in property <[float]> spectrum;
    in property <[float]> vectorscope_x;
    in property <[float]> vectorscope_y;
    in property <[float]> waveform;
    in property <int> playhead-index: 0;
    in property <[string]> engine-types;
    in-out property <int> engine-index: 0;
    in-out property <bool> engine-loaded: false;
    in-out property <bool> show-engine-confirm: false;
    in property <string> engine-confirm-text;

    in-out property <bool> show-settings: false;
    in property <[string]> output-devices;
    in-out property <int> output-device-index: 0;
    in property <[string]> input-devices;
    in-out property <int> input-device-index: 0;
    in property <[string]> sample-rates;
    in-out property <int> sample-rate-index: 0;
    in property <[string]> buffer-sizes;
    in-out property <int> buffer-size-index: 0;
    in property <string> settings-status: "";

    callback select-track(track: int);
    callback toggle-play();
    callback toggle-record();
    callback load-sample();
    callback gain-changed(value: float);
    callback track-level-changed(value: float);
    callback toggle-track-mute();
    callback tape-speed-changed(value: float);
    callback tape-tempo-changed(value: float);
    callback tape-rate-mode-selected(index: int);
    callback tape-rotate-changed(value: float);
    callback tape-glide-changed(value: float);
    callback tape-sos-changed(value: float);
    callback toggle-tape-reverse();
    callback toggle-tape-freeze();
    callback toggle-tape-keylock();
    callback toggle-tape-monitor();
    callback toggle-tape-overdub();
    callback save-sample();
    callback loop-start-changed(value: float);
    callback loop-length-changed(value: float);
    callback loop-xfade-changed(value: float);
    callback toggle-loop-enabled();
    callback loop-mode-selected(index: int);
    callback visualizer-mode-selected(index: int);
    callback quit();
    callback toggle-settings();
    callback save-project();
    callback load-project();
    callback output-device-selected(index: int);
    callback input-device-selected(index: int);
    callback sample-rate-selected(index: int);
    callback buffer-size-selected(index: int);
    callback refresh-devices();
    callback apply-settings();
    callback load-engine();
    callback confirm-engine-load();
    callback cancel-engine-load();

    background: #0f0f12;

    VerticalLayout {
        width: Math.min(parent.width, 1200px);
        x: (parent.width - self.width) / 2;
        padding: 12px;
        spacing: 8px;

        HorizontalLayout {
            width: parent.width;
            spacing: 16px;

            Text {
                text: "GrainRust";
                color: #f0f0f2;
                font-size: 24px;
                font-weight: 600;
            }

            VerticalLayout {
                spacing: 4px;
                width: 320px;
                Slider {
                    value: root.gain;
                    minimum: 0;
                    maximum: 1;
                    changed => {
                        root.gain = self.value;
                        root.gain-changed(self.value);
                    }
                }
            }

            VerticalLayout {
                spacing: 6px;
                VUMeter { level: root.meter-left; fill-color: #34d399; }
                VUMeter { level: root.meter-right; fill-color: #60a5fa; }
            }
        }

        Text {
            text: "Active Track: " + root.selected-track;
            color: #b9b9bf;
            font-size: 16px;
        }

        HorizontalLayout {
            spacing: 8px;
            for track[i] in [0, 1, 2, 3] : TrackButton {
                label: "Track " + (i + 1);
                active: (i + 1) == root.selected-track;
                clicked => { root.select-track(i + 1); }
            }
        }

        HorizontalLayout {
            spacing: 8px;
            Text { text: "Engine"; color: #b9b9bf; font-size: 13px; width: 60px; vertical-alignment: center; }
            ComboBox {
                model: root.engine-types;
                current-index: root.engine-index;
                selected => { root.engine-index = self.current-index; }
            }
            Button { text: "Load Engine"; clicked => root.load-engine(); }
        }

        VerticalLayout {
            visible: root.engine-loaded;
            spacing: 8px;
            width: parent.width;

            HorizontalLayout {
                width: parent.width;
                spacing: 12px;

                Rectangle {
                    width: parent.width * 0.6;
                    height: 120px;
                    background: #121216;
                    border-radius: 6px;
                    border-color: #2a2a35;
                    border-width: 1px;
                    HorizontalLayout {
                        padding: 8px;
                        spacing: 8px;

                        VerticalLayout {
                            width: 44px;
                            height: parent.height - 16px;
                            spacing: 0px;
                            Text { text: "+6 dB"; color: #8c8c95; font-size: 10px; }
                            Rectangle { height: (parent.height - 36px) / 2; width: 1px; background: transparent; }
                            Text { text: "0 dB"; color: #b9b9bf; font-size: 11px; }
                            Rectangle { height: (parent.height - 36px) / 2; width: 1px; background: transparent; }
                            Text { text: "-60 dB"; color: #6c6c74; font-size: 10px; }
                        }

                        VerticalLayout {
                            spacing: 6px;
                            width: parent.width - 52px;
                            Rectangle {
                                width: parent.width;
                                height: parent.height - 20px;
                                background: transparent;
                                clip: true;

                                Rectangle {
                                    width: parent.width;
                                    height: parent.height;
                                    for amp[index] in root.waveform : Rectangle {
                                        width: parent.width / root.waveform.length;
                                        height: parent.height;
                                        x: index * (parent.width / root.waveform.length);
                                        background: transparent;
                                        Rectangle {
                                            width: parent.width;
                                            height: Math.max(2px, Math.abs(amp) * (parent.height - 4px));
                                            y: (parent.height - self.height) / 2;
                                            background: index < root.playhead-index ? #c53bff : #4a0d7a;
                                            border-radius: 1px;
                                        }
                                    }
                                }
                            }

                            Rectangle {
                                width: parent.width;
                                height: 14px;
                                background: transparent;
                                for label[i] in root.waveform_time_labels : Text {
                                    text: label;
                                    color: #8c8c95;
                                    font-size: 10px;
                                    x: i * (parent.width / root.waveform_time_labels.length);
                                    y: 0px;
                                }
                            }
                        }
                    }
                }

                VerticalLayout {
                    width: 32px;
                    height: 120px;
                    spacing: 6px;
                    HorizontalLayout {
                        spacing: 4px;
                        VerticalVUMeter { level: root.track-meter-left; fill-color: #34d399; }
                        VerticalVUMeter { level: root.track-meter-right; fill-color: #60a5fa; }
                    }
                }

                Rectangle {
                    width: parent.width * 0.36 - 32px;
                    height: 120px;
                    background: #121216;
                    border-radius: 6px;
                    border-color: #2a2a35;
                    border-width: 1px;
                    VerticalLayout {
                        padding: 8px;
                        spacing: 6px;
                        HorizontalLayout {
                            spacing: 6px;
                            VizToggle {
                                active: root.visualizer-mode == 0;
                                clicked => { root.visualizer-mode = 0; root.visualizer-mode-selected(0); }
                            }
                            VizToggle {
                                active: root.visualizer-mode == 1;
                                clicked => { root.visualizer-mode = 1; root.visualizer-mode-selected(1); }
                            }
                            VizToggle {
                                active: root.visualizer-mode == 2;
                                clicked => { root.visualizer-mode = 2; root.visualizer-mode-selected(2); }
                            }
                            Text {
                                text: root.visualizer-modes[root.visualizer-mode];
                                color: #b9b9bf;
                                font-size: 12px;
                            }
                        }
                        Rectangle {
                            width: parent.width - 16px;
                            height: parent.height - 36px;
                            background: #0f0f14;
                            border-radius: 4px;
                            clip: true;

                            Rectangle {
                                width: parent.width;
                                height: parent.height;
                                visible: root.visualizer-mode == 0;
                                for sample[i] in root.oscilloscope : Rectangle {
                                    width: 2px;
                                    height: Math.max(2px, Math.abs(sample) * (parent.height - 4px));
                                    x: i * (parent.width / root.oscilloscope.length);
                                    y: (parent.height - self.height) / 2;
                                    background: #7dd3fc;
                                }
                            }

                            Rectangle {
                                width: parent.width;
                                height: parent.height;
                                visible: root.visualizer-mode == 1;
                                for mag[i] in root.spectrum : Rectangle {
                                    width: parent.width / root.spectrum.length;
                                    height: Math.max(2px, mag * (parent.height - 4px));
                                    x: i * (parent.width / root.spectrum.length);
                                    y: parent.height - self.height;
                                    background: #a78bfa;
                                }
                            }

                            Rectangle {
                                width: parent.width;
                                height: parent.height;
                                visible: root.visualizer-mode == 2;
                                for xval[i] in root.vectorscope_x : Rectangle {
                                    width: 2px;
                                    height: 2px;
                                    x: ((xval * 0.5) + 0.5) * parent.width;
                                    y: ((root.vectorscope_y[i] * -0.5) + 0.5) * parent.height;
                                    background: #34d399;
                                }
                            }
                        }
                    }
                }
            }

            HorizontalLayout {
                spacing: 16px;
                width: parent.width;

                VerticalLayout {
                    spacing: 6px;
                    width: (parent.width - 16px) / 2;

                    HorizontalLayout {
                        spacing: 8px;
                        Text { text: "Track Level"; color: #b9b9bf; font-size: 13px; width: 100px; vertical-alignment: center; }
                        Slider {
                            value: root.track-level;
                            minimum: 0;
                            maximum: 1;
                            changed => {
                                root.track-level = self.value;
                                root.track-level-changed(self.value);
                            }
                        }
                    }

                    HorizontalLayout {
                        spacing: 8px;
                        Text { text: "Tape Speed"; color: #b9b9bf; font-size: 13px; width: 100px; vertical-alignment: center; }
                        Slider {
                            value: root.tape-speed;
                            minimum: -4;
                            maximum: 4;
                            changed => {
                                root.tape-speed = self.value;
                                root.tape-speed-changed(self.value);
                            }
                        }
                    }

                    HorizontalLayout {
                        spacing: 8px;
                        Text { text: "Tape Tempo"; color: #b9b9bf; font-size: 13px; width: 100px; vertical-alignment: center; }
                        Slider {
                            value: root.tape-tempo;
                            minimum: 20;
                            maximum: 240;
                            changed => {
                                root.tape-tempo = self.value;
                                root.tape-tempo-changed(self.value);
                            }
                        }
                    }

                    HorizontalLayout {
                        spacing: 8px;
                        Text { text: "Rate Mode"; color: #b9b9bf; font-size: 13px; width: 100px; vertical-alignment: center; }
                        ComboBox {
                            model: root.tape-rate-modes;
                            current-index: root.tape-rate-mode;
                            selected => { root.tape-rate-mode-selected(self.current-index); }
                        }
                    }

                    HorizontalLayout {
                        spacing: 8px;
                        Text { text: "Tape Rotate"; color: #b9b9bf; font-size: 13px; width: 100px; vertical-alignment: center; }
                        Slider {
                            value: root.tape-rotate;
                            minimum: 0;
                            maximum: 1;
                            changed => {
                                root.tape-rotate = self.value;
                                root.tape-rotate-changed(self.value);
                            }
                        }
                    }

                    HorizontalLayout {
                        spacing: 8px;
                        Button {
                            text: root.track-muted ? "Unmute" : "Mute";
                            clicked => root.toggle-track-mute();
                        }
                        Button {
                            text: root.loop-enabled ? "Loop On" : "Loop Off";
                            clicked => root.toggle-loop-enabled();
                        }
                    }

                    HorizontalLayout {
                        spacing: 8px;
                        Button {
                            text: root.tape-reverse ? "Reverse On" : "Reverse Off";
                            clicked => root.toggle-tape-reverse();
                        }
                        Button {
                            text: root.tape-freeze ? "Freeze On" : "Freeze Off";
                            clicked => root.toggle-tape-freeze();
                        }
                    }

                    HorizontalLayout {
                        spacing: 8px;
                        Button {
                            text: root.tape-keylock ? "Keylock On" : "Keylock Off";
                            clicked => root.toggle-tape-keylock();
                        }
                        Button {
                            text: root.tape-monitor ? "Monitor On" : "Monitor Off";
                            clicked => root.toggle-tape-monitor();
                        }
                    }

                    HorizontalLayout {
                        spacing: 8px;
                        Button {
                            text: root.tape-overdub ? "Overdub On" : "Overdub Off";
                            clicked => root.toggle-tape-overdub();
                        }
                    }

                    HorizontalLayout {
                        spacing: 8px;
                        Text { text: "Loop Mode"; color: #b9b9bf; font-size: 13px; width: 100px; vertical-alignment: center; }
                        ComboBox {
                            model: root.loop-modes;
                            current-index: root.loop-mode;
                            selected => { root.loop-mode-selected(self.current-index); }
                        }
                    }
                }

                VerticalLayout {
                    spacing: 6px;
                    width: (parent.width - 16px) / 2;

                    HorizontalLayout {
                        spacing: 8px;
                        Text { text: "Loop Start"; color: #b9b9bf; font-size: 13px; width: 100px; vertical-alignment: center; }
                        Slider {
                            value: root.loop-start;
                            minimum: 0;
                            maximum: 1;
                            changed => {
                                root.loop-start = self.value;
                                root.loop-start-changed(self.value);
                            }
                        }
                    }

                    HorizontalLayout {
                        spacing: 8px;
                        Text { text: "Loop Length"; color: #b9b9bf; font-size: 13px; width: 100px; vertical-alignment: center; }
                        Slider {
                            value: root.loop-length;
                            minimum: 0.01;
                            maximum: 1;
                            changed => {
                                root.loop-length = self.value;
                                root.loop-length-changed(self.value);
                            }
                        }
                    }

                    HorizontalLayout {
                        spacing: 8px;
                        Text { text: "Tape Glide"; color: #b9b9bf; font-size: 13px; width: 100px; vertical-alignment: center; }
                        Slider {
                            value: root.tape-glide;
                            minimum: 0;
                            maximum: 1;
                            changed => {
                                root.tape-glide = self.value;
                                root.tape-glide-changed(self.value);
                            }
                        }
                    }

                    HorizontalLayout {
                        spacing: 8px;
                        Text { text: "Tape SOS"; color: #b9b9bf; font-size: 13px; width: 100px; vertical-alignment: center; }
                        Slider {
                            value: root.tape-sos;
                            minimum: 0;
                            maximum: 1;
                            changed => {
                                root.tape-sos = self.value;
                                root.tape-sos-changed(self.value);
                            }
                        }
                    }

                    HorizontalLayout {
                        spacing: 8px;
                        Text { text: "Loop XFade"; color: #b9b9bf; font-size: 13px; width: 100px; vertical-alignment: center; }
                        Slider {
                            value: root.loop-xfade;
                            minimum: 0;
                            maximum: 0.5;
                            changed => {
                                root.loop-xfade = self.value;
                                root.loop-xfade-changed(self.value);
                            }
                        }
                    }
                }
            }

            HorizontalLayout {
                spacing: 8px;
                width: parent.width;
                Button { text: "Load Sample"; clicked => root.load-sample(); }
                Button { text: "Save Sample"; clicked => root.save-sample(); }
                Button { text: root.is-recording ? "Stop Record" : "Record"; clicked => root.toggle-record(); }
                Button { text: root.is-playing ? "Stop" : "Play"; clicked => root.toggle-play(); }
                Button { text: "Settings"; clicked => root.toggle-settings(); }
                Button { text: "Quit"; clicked => root.quit(); }
            }

            HorizontalLayout {
                spacing: 8px;
                width: parent.width;
                Button { text: "Save Project"; clicked => root.save-project(); }
                Button { text: "Load Project"; clicked => root.load-project(); }
            }

            Rectangle {
                visible: root.show-settings;
                width: parent.width;
                background: #15151c;
                border-color: #2a2a35;
                border-width: 1px;
                border-radius: 6px;
                VerticalLayout {
                    padding: 12px;
                    spacing: 8px;

                    Text { text: "Audio Settings"; color: #e4e4ea; font-size: 16px; }

                    HorizontalLayout {
                        spacing: 8px;
                        Text { text: "Output device"; color: #9c9ca4; font-size: 13px; width: 110px; vertical-alignment: center; }
                        ComboBox {
                            model: root.output-devices;
                            current-index: root.output-device-index;
                            selected => { root.output-device-selected(self.current-index); }
                        }
                    }

                    HorizontalLayout {
                        spacing: 8px;
                        Text { text: "Input device"; color: #9c9ca4; font-size: 13px; width: 110px; vertical-alignment: center; }
                        ComboBox {
                            model: root.input-devices;
                            current-index: root.input-device-index;
                            selected => { root.input-device-selected(self.current-index); }
                        }
                    }

                    HorizontalLayout {
                        spacing: 8px;
                        Text { text: "Sample rate"; color: #9c9ca4; font-size: 13px; width: 110px; vertical-alignment: center; }
                        ComboBox {
                            model: root.sample-rates;
                            current-index: root.sample-rate-index;
                            selected => { root.sample-rate-selected(self.current-index); }
                        }
                    }

                    HorizontalLayout {
                        spacing: 8px;
                        Text { text: "Buffer size"; color: #9c9ca4; font-size: 13px; width: 110px; vertical-alignment: center; }
                        ComboBox {
                            model: root.buffer-sizes;
                            current-index: root.buffer-size-index;
                            selected => { root.buffer-size-selected(self.current-index); }
                        }
                    }

                    HorizontalLayout {
                        spacing: 8px;
                        Button { text: "Refresh Devices"; clicked => root.refresh-devices(); }
                        Button { text: "Apply & Restart"; clicked => root.apply-settings(); }
                    }

                    Text {
                        text: root.settings-status;
                        color: #d0a7ff;
                        font-size: 12px;
                    }
                }
            }
        }


    Rectangle {
        visible: root.show-engine-confirm;
        width: parent.width;
        height: parent.height;
        background: #00000080;

        Rectangle {
            width: Math.min(420px, parent.width - 40px);
            height: 180px;
            x: (parent.width - self.width) / 2;
            y: (parent.height - self.height) / 2;
            background: #15151c;
            border-color: #2a2a35;
            border-width: 1px;
            border-radius: 8px;

            VerticalLayout {
                padding: 16px;
                spacing: 12px;
                Text {
                    text: "Replace engine?";
                    color: #f0f0f2;
                    font-size: 16px;
                }
                Text {
                    text: root.engine-confirm-text;
                    color: #b9b9bf;
                    font-size: 12px;
                }
                HorizontalLayout {
                    spacing: 8px;
                    Button { text: "Cancel"; clicked => root.cancel-engine-load(); }
                    Button { text: "Proceed to load..."; clicked => root.confirm-engine-load(); }
                }
            }
        }
    }
}

}
